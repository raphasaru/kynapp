---
phase: 02-core-financial-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/ui/select.tsx
  - src/components/ui/dialog.tsx
  - src/components/ui/popover.tsx
  - src/components/ui/command.tsx
  - src/components/ui/calendar.tsx
  - src/lib/formatters/currency.ts
  - src/lib/formatters/date.ts
  - src/lib/validators/transaction.ts
  - src/lib/validators/account.ts
  - src/lib/validators/card.ts
  - src/hooks/use-media-query.ts
  - src/hooks/use-month-selector.ts
  - src/providers/query-provider.tsx
  - src/app/(app)/layout.tsx
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "TanStack Query provider wraps authenticated app"
    - "Currency formatter outputs pt-BR format (R$ 1.234,56)"
    - "Date formatter outputs pt-BR format (dd/MM/yyyy)"
    - "Zod schemas exist for transaction, account, card validation"
    - "Shadcn select, dialog, popover, command, calendar components available"
  artifacts:
    - path: "src/lib/formatters/currency.ts"
      provides: "formatCurrency helper"
      exports: ["formatCurrency"]
    - path: "src/lib/formatters/date.ts"
      provides: "pt-BR date formatting"
      exports: ["formatDate", "formatMonthYear"]
    - path: "src/lib/validators/transaction.ts"
      provides: "Transaction Zod schema"
      exports: ["transactionSchema"]
    - path: "src/lib/validators/account.ts"
      provides: "Bank account Zod schema"
      exports: ["accountSchema"]
    - path: "src/lib/validators/card.ts"
      provides: "Credit card Zod schema"
      exports: ["cardSchema"]
    - path: "src/providers/query-provider.tsx"
      provides: "TanStack Query wrapper"
      exports: ["QueryProvider"]
    - path: "src/hooks/use-media-query.ts"
      provides: "Desktop detection hook"
      exports: ["useMediaQuery"]
  key_links:
    - from: "src/providers/query-provider.tsx"
      to: "src/app/(app)/layout.tsx"
      via: "wraps children in QueryClientProvider"
      pattern: "QueryProvider"
---

<objective>
Install dependencies, add shadcn components, create shared utilities (formatters, validators, hooks), set up TanStack Query provider, and update database types for Phase 2.

Purpose: All Phase 2 plans need these shared utilities. Installing deps and creating foundation avoids duplication.
Output: Formatters, validators, hooks, query provider, shadcn components ready for use.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@reference/categories.ts
@reference/encryption-schemas.ts
@src/types/database.ts
@src/lib/crypto/encrypt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps + add shadcn components</name>
  <files>package.json</files>
  <action>
1. Install npm deps:
```bash
npm install recharts date-fns react-currency-input-field
```

2. Add shadcn components (select, dialog, popover, command, calendar):
```bash
npx shadcn@latest add select dialog popover command calendar --yes
```

3. Verify all installed correctly.
  </action>
  <verify>`npm ls recharts date-fns react-currency-input-field` shows all installed. `ls src/components/ui/select.tsx src/components/ui/dialog.tsx src/components/ui/calendar.tsx` shows files exist.</verify>
  <done>recharts, date-fns, react-currency-input-field in package.json. Select, dialog, popover, command, calendar components in src/components/ui/.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared utilities, hooks, query provider, update types</name>
  <files>
    src/lib/formatters/currency.ts
    src/lib/formatters/date.ts
    src/lib/validators/transaction.ts
    src/lib/validators/account.ts
    src/lib/validators/card.ts
    src/hooks/use-media-query.ts
    src/hooks/use-month-selector.ts
    src/providers/query-provider.tsx
    src/app/(app)/layout.tsx
    src/types/database.ts
  </files>
  <action>
1. **src/lib/formatters/currency.ts** — Export `formatCurrency(n: number): string` using `Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })`. Handle edge cases (negative, zero, undefined → "R$ 0,00").

2. **src/lib/formatters/date.ts** — Export:
   - `formatDate(date: Date | string, pattern?: string): string` — defaults to 'dd/MM/yyyy', uses date-fns with ptBR locale. Parse string dates as local time (`+ 'T00:00:00'`).
   - `formatMonthYear(month: string): string` — takes 'yyyy-MM', returns "Fevereiro 2026" (capitalized month name).
   - `getMonthRange(month: string): { start: string; end: string }` — returns first and last day of month as 'yyyy-MM-dd'.

3. **src/lib/validators/transaction.ts** — Zod schema:
   - `description`: string, min 1 ("Descrição obrigatória")
   - `amount`: number, positive ("Valor deve ser positivo")
   - `type`: enum ['income', 'expense']
   - `category`: enum of all 9 expense_category values, optional (nullable for income)
   - `status`: enum ['planned', 'completed'], default 'completed'
   - `due_date`: string (yyyy-MM-dd format)
   - `payment_method`: enum ['pix', 'cash', 'debit', 'credit', 'transfer', 'boleto'], optional
   - `bank_account_id`: string uuid, optional nullable
   - `credit_card_id`: string uuid, optional nullable
   - `notes`: string, optional
   Export type `TransactionInput` inferred from schema.

4. **src/lib/validators/account.ts** — Zod schema:
   - `name`: string, min 1 ("Nome obrigatório")
   - `type`: enum ['checking', 'savings', 'investment']
   - `balance`: number, default 0
   - `bank_name`: string, optional
   - `color`: string, optional
   Export type `AccountInput`.

5. **src/lib/validators/card.ts** — Zod schema:
   - `name`: string, min 1 ("Nome obrigatório")
   - `credit_limit`: number, positive ("Limite deve ser positivo")
   - `due_day`: number, int, min 1, max 31 ("Dia entre 1 e 31")
   - `closing_day`: number, int, min 1, max 31
   - `color`: string, optional
   Export type `CardInput`.

6. **src/hooks/use-media-query.ts** — 'use client'. Export `useMediaQuery(query: string): boolean`. Uses `window.matchMedia`, listens for changes, handles SSR (default false). Used for sheet-on-mobile/dialog-on-desktop pattern.

7. **src/hooks/use-month-selector.ts** — 'use client'. Export `useMonthSelector()` returning `{ month, setMonth, prevMonth, nextMonth, monthLabel }`. Uses `useSearchParams` for URL state. `month` defaults to current month ('yyyy-MM'). `monthLabel` returns formatted name via `formatMonthYear`.

8. **src/providers/query-provider.tsx** — 'use client'. Create `QueryProvider` component wrapping children in `QueryClientProvider` with `new QueryClient({ defaultOptions: { queries: { staleTime: 5 * 60 * 1000, retry: 1 } } })`. Use `useState` for client to avoid SSR issues.

9. **src/app/(app)/layout.tsx** — Wrap children with `<QueryProvider>`. Import from `@/providers/query-provider`. Keep existing auth check, Sidebar, BottomNav structure. The QueryProvider goes inside the layout JSX wrapping `{children}`.

10. **src/types/database.ts** — Add `credit_cards` table type matching schema (id, user_id, name, credit_limit: string, current_bill: string, due_day: number, closing_day: number, color: string | null, created_at, updated_at). Also add missing fields to `transactions` table: `payment_method`, `bank_account_id`, `credit_card_id`, `notes`, `completed_date`, `source`, `is_recurring`. Row/Insert/Update variants.
  </action>
  <verify>
`npx tsc --noEmit` passes (no type errors). All files exist with correct exports. Check: `grep -l "formatCurrency" src/lib/formatters/currency.ts`, `grep -l "QueryProvider" src/providers/query-provider.tsx`, `grep "credit_cards" src/types/database.ts`.
  </verify>
  <done>All formatters, validators, hooks, query provider created. Database types updated with credit_cards and full transaction fields. App layout wraps children in QueryProvider. `npx tsc --noEmit` passes.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (or at minimum `npx tsc --noEmit` passes)
- `formatCurrency(1234.56)` returns "R$ 1.234,56"
- All Zod schemas parse valid input without errors
- QueryProvider wraps the (app) layout
- credit_cards type exists in database.ts
</verification>

<success_criteria>
All shared dependencies, utilities, and infrastructure ready for Plans 02-05. No plan needs to install deps or create formatters.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-financial-data/02-01-SUMMARY.md`
</output>
