---
phase: 02-core-financial-data
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/lib/queries/transactions.ts
  - src/components/transactions/transaction-form.tsx
  - src/components/transactions/transaction-item.tsx
  - src/components/transactions/category-select.tsx
  - src/components/transactions/amount-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can create transaction with type, amount, description, category, date, status, payment method"
    - "User can edit an existing transaction"
    - "User can delete a transaction"
    - "User can mark planned transaction as completed"
    - "User can associate transaction with bank account"
    - "User can associate transaction with credit card (when payment=credit)"
    - "Category select shows 9 categories with icons"
  artifacts:
    - path: "src/lib/queries/transactions.ts"
      provides: "TanStack Query hooks for transactions"
      exports: ["useTransactions", "useCreateTransaction", "useUpdateTransaction", "useDeleteTransaction", "useToggleTransactionStatus"]
    - path: "src/components/transactions/transaction-form.tsx"
      provides: "Transaction create/edit form"
      exports: ["TransactionForm"]
    - path: "src/components/transactions/transaction-item.tsx"
      provides: "Transaction list item"
      exports: ["TransactionItem"]
    - path: "src/components/transactions/category-select.tsx"
      provides: "Category picker with icons"
      exports: ["CategorySelect"]
    - path: "src/components/transactions/amount-input.tsx"
      provides: "Masked BRL currency input"
      exports: ["AmountInput"]
  key_links:
    - from: "src/lib/queries/transactions.ts"
      to: "supabase.from('transactions')"
      via: "TanStack Query with encrypt/decrypt"
      pattern: "encryptFields.*transactions"
    - from: "src/components/transactions/transaction-form.tsx"
      to: "src/lib/queries/transactions.ts"
      via: "useCreateTransaction/useUpdateTransaction"
      pattern: "useCreateTransaction|useUpdateTransaction"
    - from: "src/components/transactions/transaction-form.tsx"
      to: "src/lib/queries/accounts.ts"
      via: "useAccounts for account selector"
      pattern: "useAccounts"
    - from: "src/components/transactions/transaction-form.tsx"
      to: "src/lib/queries/cards.ts"
      via: "useCards for card selector (when payment=credit)"
      pattern: "useCards"
---

<objective>
Implement transaction CRUD with encrypted fields, category selection, payment method association with accounts/cards, and status toggle.

Purpose: TRNS-01 through TRNS-06, CATG-01 through CATG-03 — core transaction management. This is the heart of the app.
Output: Transaction form, list item component, category picker, currency input — all reusable by dashboard.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-financial-data/02-01-SUMMARY.md
@.planning/phases/02-core-financial-data/02-02-SUMMARY.md
@.planning/phases/02-core-financial-data/02-03-SUMMARY.md
@src/lib/crypto/encrypt.ts
@src/types/database.ts
@reference/categories.ts
@reference/encryption-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TanStack Query hooks for transactions</name>
  <files>src/lib/queries/transactions.ts</files>
  <action>
Create `src/lib/queries/transactions.ts` with 'use client'.

1. **useTransactions(month: string)** — `useQuery` key `['transactions', month]`. Fetch transactions where `due_date >= '{month}-01'` and `due_date < nextMonth`. Use `.gte('due_date', ...)` and `.lt('due_date', ...)` filters. Order by due_date desc. Decrypt each row via `decryptFields('transactions', row)`. After decryption, `amount` is number and `description` is string.

   Month range calculation: use `getMonthRange` from formatters/date (or inline: addMonths from date-fns to get next month start).

2. **useCreateTransaction()** — `useMutation`. Receives values from form. Gets user. Prepares insert object: `{ ...values, user_id, due_date: format(values.due_date, 'yyyy-MM-dd') }`. If `payment_method !== 'credit'`, clear `credit_card_id`. If no bank account selected and payment not credit, optionally use default. Encrypt via `encryptFields('transactions', obj)`. Insert + select + decrypt response. Invalidates `['transactions']` (all months — use `{ queryKey: ['transactions'] }` to cover current and adjacent).

3. **useUpdateTransaction()** — `useMutation`. Takes `{ id, ...values }`. Encrypt, update, decrypt. Invalidates `['transactions']`.

4. **useDeleteTransaction()** — `useMutation`. Delete by id. Invalidates `['transactions']`.

5. **useToggleTransactionStatus()** — `useMutation` with optimistic updates. Takes `{ id, currentStatus }`. Toggles planned↔completed. On toggle to completed, sets `completed_date` to today. On toggle to planned, clears `completed_date`. Optimistic: `onMutate` cancels queries, snapshots previous, updates cache inline. `onError` rolls back. `onSettled` invalidates. Pattern from research doc.

6. **useSearchTransactions(month: string, query: string)** — NOT a separate hook. Instead, export a helper `filterTransactionsBySearch(transactions: DecryptedTransaction[], query: string): DecryptedTransaction[]` that filters already-decrypted transactions by description substring match (case-insensitive). Dashboard uses this client-side after `useTransactions` returns data. This covers TRNS-07.
  </action>
  <verify>`npx tsc --noEmit` passes. All hooks exported. `grep "encryptFields\|decryptFields" src/lib/queries/transactions.ts` shows encryption used.</verify>
  <done>Transaction query hooks with encryption, optimistic status toggle, client-side search filter, month-based fetching.</done>
</task>

<task type="auto">
  <name>Task 2: Transaction form + list item + category select + amount input</name>
  <files>
    src/components/transactions/transaction-form.tsx
    src/components/transactions/transaction-item.tsx
    src/components/transactions/category-select.tsx
    src/components/transactions/amount-input.tsx
  </files>
  <action>
1. **src/components/transactions/amount-input.tsx** — 'use client'. Wraps `react-currency-input-field` with React Hook Form `Controller`. Props: `control`, `name`. Config: `intlConfig={{ locale: 'pt-BR', currency: 'BRL' }}`, `decimalsLimit={2}`, `decimalSeparator=","`, `groupSeparator="."`, `prefix="R$ "`. `onValueChange` parses to float, calls `field.onChange`. Shows field error message below.

2. **src/components/transactions/category-select.tsx** — 'use client'. Uses shadcn `Select`. Maps `categoryLabels` and `categoryIcons` from `reference/categories.ts` (copy to src/lib or import directly). Each item shows Lucide icon + label. Separate optgroups: "Fixas" (fixed_*) and "Variáveis" (variable_*). Props: `value`, `onChange`. Include placeholder "Selecione categoria".

   For icons: import specific icons from lucide-react based on categoryIcons values: `{ Home, Zap, CreditCard, User, FileText, UtensilsCrossed, Car, MoreHorizontal }`. Create a mapping object `iconMap` to look up by string name.

3. **src/components/transactions/transaction-form.tsx** — 'use client'. React Hook Form + Zod (`transactionSchema`). Full form:
   - **Type toggle**: Two buttons (Receita/Despesa) side by side, active state highlighted. Green for income, red for expense. Controls `type` field.
   - **Amount**: `AmountInput` component.
   - **Description**: Input text.
   - **Category**: `CategorySelect`. Only show for expenses (hide when type=income).
   - **Date**: Input type date, default today, formatted yyyy-MM-dd.
   - **Status**: Two buttons (Planejada/Realizada) for planned/completed.
   - **Payment method**: Select with options: PIX, Dinheiro, Débito, Crédito, Transferência, Boleto (mapped to enum values).
   - **Bank account**: Select showing user's accounts (from `useAccounts()`). Show when payment != credit. Label "Conta bancária".
   - **Credit card**: Select showing user's cards (from `useCards()`). Show ONLY when payment_method = 'credit'. Label "Cartão de crédito".
   - **Notes**: Textarea, optional.
   - **Submit button**: "Salvar" with loading state (isPending).

   Props: `transaction?` (edit mode pre-fills), `onSuccess`, `defaultMonth?` (for date default).
   Uses `useCreateTransaction` or `useUpdateTransaction`.
   Prevent Enter key submission (`onKeyDown` handler on form).

4. **src/components/transactions/transaction-item.tsx** — 'use client'. Displays single transaction in list:
   - Left: category icon (from categoryIcons map) + colored circle bg (green for income, red for expense)
   - Center: description (top), category label + date (bottom, smaller text)
   - Right: formatted amount (green "+R$ X" for income, red "-R$ X" for expense)
   - Status indicator: checkbox or circle — filled for completed, empty for planned. Clicking toggles via `useToggleTransactionStatus`.
   - Tap/click opens edit form (calls `onEdit` callback).
   - Swipe-to-delete not needed — edit form has delete button.
   Props: `transaction`, `onEdit`.
  </action>
  <verify>`npx tsc --noEmit` passes. All 4 components export correctly. `grep "CategorySelect\|AmountInput\|TransactionForm\|TransactionItem" src/components/transactions/*.tsx` shows all present.</verify>
  <done>Complete transaction UI: masked currency input, category picker with icons and groups, full form with conditional account/card selectors, list item with status toggle. All encrypted fields handled transparently.</done>
</task>

</tasks>

<verification>
- TransactionForm renders with all fields
- Type toggle switches between income/expense, hiding category for income
- Payment method = credit shows card selector, hides account selector
- AmountInput accepts "1.234,56" format, stores as number
- CategorySelect shows 9 categories with icons in fixed/variable groups
- TransactionItem shows icon, description, amount (colored), status
- Status toggle fires optimistic update
</verification>

<success_criteria>
TRNS-01 through TRNS-06 components ready. CATG-01 through CATG-03 implemented via CategorySelect. Components are reusable — dashboard (Plan 05) uses TransactionItem and TransactionForm directly.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-financial-data/02-04-SUMMARY.md`
</output>
