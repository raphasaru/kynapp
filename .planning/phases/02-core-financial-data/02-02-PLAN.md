---
phase: 02-core-financial-data
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/queries/accounts.ts
  - src/components/accounts/account-form.tsx
  - src/components/accounts/account-card.tsx
  - src/components/accounts/bank-select.tsx
  - src/app/(app)/carteira/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can add bank account with name, type, balance, and optional bank name"
    - "User can edit a bank account"
    - "User can delete a bank account"
    - "User can set a default bank account"
    - "User can select from pre-populated list of Brazilian banks"
    - "User sees balance per account (decrypted)"
  artifacts:
    - path: "src/lib/queries/accounts.ts"
      provides: "TanStack Query hooks for bank accounts"
      exports: ["useAccounts", "useCreateAccount", "useUpdateAccount", "useDeleteAccount", "useSetDefaultAccount"]
    - path: "src/components/accounts/account-form.tsx"
      provides: "Bank account create/edit form"
      exports: ["AccountForm"]
    - path: "src/components/accounts/account-card.tsx"
      provides: "Bank account display card"
      exports: ["AccountCard"]
    - path: "src/app/(app)/carteira/page.tsx"
      provides: "Wallet page with accounts list"
  key_links:
    - from: "src/lib/queries/accounts.ts"
      to: "supabase.from('bank_accounts')"
      via: "TanStack Query queryFn"
      pattern: "encryptFields.*bank_accounts"
    - from: "src/components/accounts/account-form.tsx"
      to: "src/lib/queries/accounts.ts"
      via: "useCreateAccount/useUpdateAccount mutations"
      pattern: "useCreateAccount|useUpdateAccount"
    - from: "src/app/(app)/carteira/page.tsx"
      to: "src/lib/queries/accounts.ts"
      via: "useAccounts hook"
      pattern: "useAccounts"
---

<objective>
Implement bank accounts CRUD with encrypted balance, Brazilian bank selector, and wallet page displaying accounts.

Purpose: BANK-01 through BANK-06 — users need accounts before associating transactions.
Output: Working bank accounts management on /app/carteira page.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-financial-data/02-01-SUMMARY.md
@src/lib/crypto/encrypt.ts
@src/lib/supabase/client.ts
@src/types/database.ts
@reference/encryption-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TanStack Query hooks for bank accounts</name>
  <files>src/lib/queries/accounts.ts</files>
  <action>
Create `src/lib/queries/accounts.ts` with 'use client' directive. All hooks use browser Supabase client from `@/lib/supabase/client`.

1. **useAccounts()** — `useQuery` with key `['accounts']`. queryFn fetches `bank_accounts` filtered by user (RLS handles it), ordered by created_at desc. Decrypt each row using `decryptFields('bank_accounts', row)`. Returns decrypted accounts array.

2. **useCreateAccount()** — `useMutation`. mutationFn receives `AccountInput`, gets user via `supabase.auth.getUser()`, encrypts with `encryptFields('bank_accounts', { ...values, user_id })`, inserts via `supabase.from('bank_accounts').insert().select().single()`, decrypts response. `onSuccess` invalidates `['accounts']`.

3. **useUpdateAccount()** — `useMutation`. Takes `{ id, ...values }`. Encrypts changed fields, updates via `.update().eq('id', id).select().single()`. Invalidates `['accounts']`.

4. **useDeleteAccount()** — `useMutation`. Takes account id. Deletes via `.delete().eq('id', id)`. Invalidates `['accounts']`.

5. **useSetDefaultAccount()** — `useMutation`. Takes account id. Updates `profiles` table: `.update({ default_bank_account_id: id }).eq('id', user.id)`. Invalidates `['accounts']` and `['profile']`.

Free tier enforcement: In `useCreateAccount`, before inserting, count existing accounts. If >= 2 and plan is 'free', throw error "Limite de 2 contas no plano gratuito". Check count via `supabase.from('bank_accounts').select('id', { count: 'exact', head: true })`.
  </action>
  <verify>`npx tsc --noEmit` passes. File exports all 5 hooks.</verify>
  <done>All account query hooks with encryption, free tier enforcement, and cache invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Account components + wallet page</name>
  <files>
    src/components/accounts/account-form.tsx
    src/components/accounts/account-card.tsx
    src/components/accounts/bank-select.tsx
    src/app/(app)/carteira/page.tsx
  </files>
  <action>
1. **src/components/accounts/bank-select.tsx** — 'use client'. Pre-populated list of ~15 major Brazilian banks: Banco do Brasil, Bradesco, Itaú, Caixa, Santander, Nubank, Inter, C6 Bank, BTG Pactual, Safra, Original, PagBank, Neon, Next, XP. Use shadcn `Select` component. Props: `value`, `onChange`. Include "Outro" option for unlisted banks.

2. **src/components/accounts/account-form.tsx** — 'use client'. React Hook Form + Zod (`accountSchema` from validators). Fields:
   - `name` (Input)
   - `type` (Select: Corrente/Poupança/Investimento mapping to checking/savings/investment)
   - `bank_name` (BankSelect component)
   - `balance` (CurrencyInput from react-currency-input-field, intlConfig pt-BR)
   - `color` (simple color input or preset swatches: 6-8 colors)
   Props: `account?` (for edit mode), `onSuccess` callback.
   Uses `useCreateAccount` or `useUpdateAccount` based on `account` prop.
   Prevent Enter key form submission (onKeyDown handler).
   Responsive: Sheet (mobile) vs Dialog (desktop) — use `useMediaQuery` hook. The form itself is the inner content; wrapping in Sheet/Dialog happens at page level.

3. **src/components/accounts/account-card.tsx** — 'use client'. Displays account info: bank name, account name, type badge, formatted balance via `formatCurrency`. Left border with account color. Shows star icon if default. Has kebab menu (three dots) with "Editar", "Definir como padrão", "Excluir" options. Excluir shows confirmation dialog. Uses `useDeleteAccount` and `useSetDefaultAccount`.

4. **src/app/(app)/carteira/page.tsx** — 'use client' (needs query hooks). Header: "Carteira" title + "Nova conta" button (Plus icon). Lists accounts using `useAccounts()`. Loading state with skeleton. Empty state: "Nenhuma conta cadastrada". Each account renders `AccountCard`. "Nova conta" opens AccountForm in Sheet (mobile) or Dialog (desktop). Also a section header "Cartões de crédito" with placeholder text "Em breve" (Plan 02-03 fills this). Use `useState` for open/close form and edit target.
  </action>
  <verify>`npx tsc --noEmit` passes. `grep -r "useAccounts\|AccountForm\|AccountCard" src/` shows components used. Page exists at src/app/(app)/carteira/page.tsx.</verify>
  <done>Complete bank account management: form with Brazilian bank selector, account cards with balance, edit/delete/default actions, wallet page listing accounts. Free tier limit enforced (2 accounts).</done>
</task>

</tasks>

<verification>
- Navigate to /app/carteira — page loads
- Click "Nova conta" — form opens (Sheet on mobile, Dialog on desktop)
- Fill form with bank, name, type, balance — account created, appears in list
- Balance shows as "R$ X.XXX,XX" (decrypted, formatted)
- Edit account — form pre-fills, saves changes
- Delete account — confirmation, removes from list
- Set default — star icon appears
- Creating 3rd account on free tier — shows error
</verification>

<success_criteria>
BANK-01 through BANK-06 fully working. Encrypted balance stored/retrieved correctly. Free tier 2-account limit enforced.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-financial-data/02-02-SUMMARY.md`
</output>
