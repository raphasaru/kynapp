---
phase: 02-core-financial-data
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/queries/cards.ts
  - src/components/cards/card-form.tsx
  - src/components/cards/card-display.tsx
  - src/app/(app)/carteira/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can add credit card with name, limit, due day, closing day"
    - "User can edit a credit card"
    - "User can delete a credit card"
    - "User can set a color for the card"
    - "User sees current bill amount (decrypted)"
  artifacts:
    - path: "src/lib/queries/cards.ts"
      provides: "TanStack Query hooks for credit cards"
      exports: ["useCards", "useCreateCard", "useUpdateCard", "useDeleteCard"]
    - path: "src/components/cards/card-form.tsx"
      provides: "Credit card create/edit form"
      exports: ["CardForm"]
    - path: "src/components/cards/card-display.tsx"
      provides: "Credit card visual display"
      exports: ["CardDisplay"]
  key_links:
    - from: "src/lib/queries/cards.ts"
      to: "supabase.from('credit_cards')"
      via: "TanStack Query queryFn with encryption"
      pattern: "encryptFields.*credit_cards"
    - from: "src/components/cards/card-form.tsx"
      to: "src/lib/queries/cards.ts"
      via: "useCreateCard/useUpdateCard mutations"
      pattern: "useCreateCard|useUpdateCard"
    - from: "src/app/(app)/carteira/page.tsx"
      to: "src/lib/queries/cards.ts"
      via: "useCards hook for listing"
      pattern: "useCards"
---

<objective>
Implement credit cards CRUD with encrypted limit/bill, color customization, and integrate into the wallet page.

Purpose: CARD-01 through CARD-05 — users need cards before associating credit transactions. CARD-04 (bill from transactions) will show bill field but calculation connects in Plan 02-04.
Output: Working credit card management integrated into /app/carteira.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-core-financial-data/02-01-SUMMARY.md
@src/lib/crypto/encrypt.ts
@src/types/database.ts
@reference/encryption-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TanStack Query hooks for credit cards</name>
  <files>src/lib/queries/cards.ts</files>
  <action>
Create `src/lib/queries/cards.ts` with 'use client'. All hooks use browser Supabase client.

1. **useCards()** — `useQuery` key `['cards']`. Fetch `credit_cards` ordered by created_at desc. Decrypt each row via `decryptFields('credit_cards', row)`. Returns array with decrypted credit_limit and current_bill as numbers.

2. **useCreateCard()** — `useMutation`. Receives `CardInput`. Gets user, encrypts fields (credit_limit, current_bill defaults to 0), inserts with user_id. Decrypts response. Invalidates `['cards']`.

3. **useUpdateCard()** — `useMutation`. Takes `{ id, ...values }`. Encrypts changed fields, updates. Invalidates `['cards']`.

4. **useDeleteCard()** — `useMutation`. Deletes by id. Invalidates `['cards']`.

Free tier: Before create, count existing cards. If >= 1 and plan is 'free', throw "Limite de 1 cartão no plano gratuito".
  </action>
  <verify>`npx tsc --noEmit` passes. File exports all 4 hooks.</verify>
  <done>All card query hooks with encryption, free tier enforcement (1 card), cache invalidation.</done>
</task>

<task type="auto">
  <name>Task 2: Card components + integrate into wallet page</name>
  <files>
    src/components/cards/card-form.tsx
    src/components/cards/card-display.tsx
    src/app/(app)/carteira/page.tsx
  </files>
  <action>
1. **src/components/cards/card-form.tsx** — 'use client'. React Hook Form + Zod (`cardSchema`). Fields:
   - `name` (Input, e.g. "Nubank Mastercard")
   - `credit_limit` (CurrencyInput, pt-BR)
   - `due_day` (Input type number, 1-31, label "Dia do vencimento")
   - `closing_day` (Input type number, 1-31, label "Dia do fechamento")
   - `color` (preset color swatches: 6-8 options like purple, teal, orange, blue, red, pink, gray, black)
   Props: `card?` (edit), `onSuccess`.
   Uses `useCreateCard` or `useUpdateCard`. Prevent Enter submission.

2. **src/components/cards/card-display.tsx** — 'use client'. Visual credit card design:
   - Card-shaped container (aspect-ratio ~1.6:1, rounded-xl, background color from card.color with gradient)
   - Card name at top-left
   - Limit: "Limite: R$ X.XXX,XX" (formatCurrency)
   - Bill: "Fatura atual: R$ X.XXX,XX" (formatCurrency)
   - Bottom row: "Vencimento: dia {due_day}" and "Fecha: dia {closing_day}"
   - Kebab menu with "Editar" and "Excluir" (with confirmation dialog for delete)
   Props: `card`, `onEdit` callback.

3. **src/app/(app)/carteira/page.tsx** — UPDATE existing page (from Plan 02-02). Replace "Cartões em breve" placeholder with actual credit cards section:
   - Section header "Cartões de crédito" + "Novo cartão" button
   - `useCards()` to fetch cards
   - Cards displayed in horizontal scrollable row (flex overflow-x-auto, snap-x) on mobile, grid on desktop
   - Empty state: "Nenhum cartão cadastrado"
   - "Novo cartão" opens CardForm in Sheet/Dialog

   NOTE: This task modifies the same file as Plan 02-02. Since 02-02 and 02-03 both depend on 02-01 (wave 2), the executor MUST run 02-02 before 02-03 to avoid conflicts on carteira/page.tsx. If parallel execution attempted, 02-03 should read the existing file from 02-02 first.
  </action>
  <verify>`npx tsc --noEmit` passes. `grep -r "useCards\|CardForm\|CardDisplay" src/` shows components used. Wallet page has both accounts and cards sections.</verify>
  <done>Credit cards CRUD working. Visual card display with color. Wallet page shows accounts section + cards section. Free tier 1-card limit enforced.</done>
</task>

</tasks>

<verification>
- Navigate to /app/carteira — shows both accounts and cards sections
- Click "Novo cartão" — form opens
- Fill form with name, limit, days, color — card created with colored display
- Card shows limit and bill (bill starts at R$ 0,00)
- Edit card — form pre-fills, saves changes
- Delete card — confirmation, removes
- Creating 2nd card on free tier — shows error
</verification>

<success_criteria>
CARD-01 through CARD-05 fully working. Encrypted limit/bill stored correctly. Visual card display with custom colors. Integrated into wallet page alongside bank accounts.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-financial-data/02-03-SUMMARY.md`
</output>
