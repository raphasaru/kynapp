---
phase: 04-integrations-and-activation
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - package.json
  - src/app/api/whatsapp/verify/route.ts
  - src/app/api/whatsapp/check/route.ts
  - src/app/api/whatsapp/unlink/route.ts
  - src/app/api/whatsapp/transaction/route.ts
  - src/lib/queries/whatsapp.ts
  - src/components/whatsapp/phone-input.tsx
  - src/components/whatsapp/verification-qr.tsx
  - src/components/whatsapp/verification-status.tsx
  - src/app/app/configuracoes/whatsapp/page.tsx
  - src/lib/validators/phone-number.ts
autonomous: true
user_setup:
  - service: whatsapp-bot
    why: "WhatsApp Business API for bot number"
    env_vars:
      - name: NEXT_PUBLIC_WHATSAPP_BOT_NUMBER
        source: "WhatsApp Business account phone number (format: 5511999999999)"
      - name: N8N_WEBHOOK_SECRET
        source: "Shared secret between n8n and Next.js for webhook auth"

must_haves:
  truths:
    - "User can enter Brazilian phone number on WhatsApp settings page"
    - "User receives 6-char verification code with 1-hour expiry"
    - "User sees 3 options to send code: QR code, open WhatsApp button, copy code"
    - "n8n can POST to /api/whatsapp/transaction to create transactions"
    - "Free user transaction creation returns 429 when 30-message limit reached"
    - "User can unlink WhatsApp number"
  artifacts:
    - path: "src/app/api/whatsapp/verify/route.ts"
      provides: "Generate verification code"
      exports: ["POST"]
    - path: "src/app/api/whatsapp/transaction/route.ts"
      provides: "n8n callback to create transaction"
      exports: ["POST"]
    - path: "src/app/app/configuracoes/whatsapp/page.tsx"
      provides: "WhatsApp settings page"
    - path: "src/components/whatsapp/verification-qr.tsx"
      provides: "QR code + deep link + copy code UI"
  key_links:
    - from: "src/app/api/whatsapp/transaction/route.ts"
      to: "supabase transactions table"
      via: "insert encrypted transaction"
      pattern: "transactions.*insert"
    - from: "src/app/api/whatsapp/transaction/route.ts"
      to: "supabase subscriptions table"
      via: "check message limit + increment counter"
      pattern: "whatsapp_messages_used"
    - from: "src/components/whatsapp/verification-qr.tsx"
      to: "wa.me deep link"
      via: "pre-filled WhatsApp message"
      pattern: "wa\\.me"
---

<objective>
WhatsApp integration: API routes for verification flow + transaction callback from n8n, settings page with phone input, QR verification, and link management.

Purpose: Core differentiator — users link WhatsApp and receive transactions from n8n bot.
Output: 4 API routes, WhatsApp query hooks, phone input, QR verification, settings page.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/001_schema.sql (user_whatsapp_links table lines 203-213, subscriptions table lines 188-201)
@.planning/phases/04-integrations-and-activation/04-RESEARCH.md (Pattern 1: WhatsApp → Transaction, Pattern 2: Verification)
@.planning/phases/04-integrations-and-activation/04-01-SUMMARY.md (Stripe routes for tier check context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: WhatsApp API routes (verify, check, unlink, transaction callback)</name>
  <files>
    package.json
    src/app/api/whatsapp/verify/route.ts
    src/app/api/whatsapp/check/route.ts
    src/app/api/whatsapp/unlink/route.ts
    src/app/api/whatsapp/transaction/route.ts
    src/lib/validators/phone-number.ts
  </files>
  <action>
    Install: `npm install qrcode react-qr-code` and `npm install -D @types/qrcode`

    **src/lib/validators/phone-number.ts**: Zod schema for Brazilian phone.
    - Pattern: `^55\d{2}9?\d{8}$` (country code 55 + 2-digit DDD + optional 9 + 8 digits)
    - Or simpler UI format: `(DD) 9XXXX-XXXX` → strip to digits, prepend 55
    - Export `phoneNumberSchema` and `formatPhoneForAPI(raw: string): string`

    **src/app/api/whatsapp/verify/route.ts**: POST handler.
    - Auth check via supabase.auth.getUser()
    - Accept `{ phone_number }` (already formatted with country code)
    - Validate phone with Zod schema
    - Generate 6-char alphanumeric code: `Math.random().toString(36).substring(2, 8).toUpperCase()`
    - Set expiry: 1 hour from now
    - Upsert into user_whatsapp_links: user_id, phone_number, verification_code, verification_expires_at, verified_at=null
    - Build WhatsApp deep link: `https://wa.me/${NEXT_PUBLIC_WHATSAPP_BOT_NUMBER}?text=${encodeURIComponent('Verificação KYN: ' + code)}`
    - Return `{ code, deepLink, expiresAt }`

    **src/app/api/whatsapp/check/route.ts**: GET handler.
    - Auth check
    - Query user_whatsapp_links for current user
    - Return `{ linked: boolean, phone_number, verified_at }` or `{ linked: false }`
    - This is polled by the client to detect when n8n confirms verification

    **src/app/api/whatsapp/unlink/route.ts**: POST handler.
    - Auth check
    - Delete from user_whatsapp_links where user_id = current user
    - Return `{ success: true }`

    **src/app/api/whatsapp/transaction/route.ts**: POST handler (called by n8n).
    - Verify n8n webhook secret: `request.headers.get('x-n8n-secret') !== process.env.N8N_WEBHOOK_SECRET` → 401
    - NO auth check (this is a server-to-server call from n8n)
    - Accept `{ phone_number, transaction_data: { amount, description, type, category } }`
    - Find user by phone: query user_whatsapp_links where phone_number AND verified_at IS NOT NULL
    - If not found → 404 "Phone not linked"
    - Check free tier limit: query subscriptions for user. If plan='free' && whatsapp_messages_used >= 30 → return 429 with upgrade message
    - Use service role Supabase client (same pattern as webhook route) for DB operations
    - Encrypt amount + description using crypto utilities
    - Insert transaction: user_id, encrypted amount/description, type, category, status='planned', due_date=today, source='whatsapp'
    - Increment whatsapp_messages_used
    - Return `{ transaction: { id, description, amount, type } }`

    IMPORTANT: transaction route uses service role key (no user session). Same pattern as Stripe webhook.
    IMPORTANT: Null-check verification_code expiry to prevent expired codes from being found.
  </action>
  <verify>
    `npx tsc --noEmit` passes. All 4 route files export their handlers. qrcode and react-qr-code installed.
  </verify>
  <done>
    4 WhatsApp API routes: verify generates code + deep link, check polls status, unlink removes connection, transaction callback creates encrypted transaction with tier enforcement.
  </done>
</task>

<task type="auto">
  <name>Task 2: WhatsApp settings page with verification UI</name>
  <files>
    src/lib/queries/whatsapp.ts
    src/components/whatsapp/phone-input.tsx
    src/components/whatsapp/verification-qr.tsx
    src/components/whatsapp/verification-status.tsx
    src/app/app/configuracoes/whatsapp/page.tsx
  </files>
  <action>
    **src/lib/queries/whatsapp.ts**: TanStack Query hooks.
    - `useWhatsAppLink()`: GET /api/whatsapp/check. Returns { linked, phone_number, verified_at }. staleTime: 30s (need fresh data during verification polling).
    - `useVerifyWhatsApp()`: mutation POST /api/whatsapp/verify with phone_number. Returns { code, deepLink, expiresAt }.
    - `useUnlinkWhatsApp()`: mutation POST /api/whatsapp/unlink. Invalidate ['whatsapp-link'] on success.
    - Enable refetchInterval: 5000 (5s polling) on useWhatsAppLink ONLY when verification is pending (code generated but not yet verified). Stop polling once verified_at is set.

    **src/components/whatsapp/phone-input.tsx**: Brazilian phone number input.
    - Masked input: (XX) 9XXXX-XXXX format
    - Use react-hook-form + Zod validation
    - Label: "Número do WhatsApp"
    - Helper text: "Formato: (11) 91234-5678"
    - Submit button: "Vincular WhatsApp"
    - Calls useVerifyWhatsApp on submit
    - Strip formatting before sending (keep only digits, prepend 55 if needed)

    **src/components/whatsapp/verification-qr.tsx**: Verification options.
    - Shown after phone submitted (code generated)
    - 3 options in a stacked layout:
      1. QR Code: `QRCodeSVG` from react-qr-code, value=deepLink, size=200, white bg wrapper with rounded-lg
      2. "Abrir WhatsApp" button (MessageCircle icon) → window.open(deepLink, '_blank')
      3. "Copiar código" button (Copy icon) → navigator.clipboard.writeText(code), show "Copiado!" for 2s
    - Display code in large mono font: `<code className="text-2xl font-mono font-bold">{code}</code>`
    - "Válido por 1 hora" text
    - Instructions: "Envie o código acima para o número do KYN no WhatsApp"
    - Countdown or "Aguardando verificação..." with spinner

    **src/components/whatsapp/verification-status.tsx**: Link status display.
    - If verified: show green CheckCircle + "WhatsApp vinculado" + phone number + verified_at date
    - "Desvincular" button (destructive variant) with AlertDialog confirmation
    - If not linked: show phone input component

    **src/app/app/configuracoes/whatsapp/page.tsx**: WhatsApp settings page.
    - Title "WhatsApp"
    - Description: "Vincule seu WhatsApp para registrar transações por mensagem"
    - State machine: not_linked → verifying → linked
      - not_linked: show PhoneInput
      - verifying: show VerificationQR (with polling via useWhatsAppLink refetchInterval)
      - linked: show VerificationStatus (green, with unlink option)
    - Back button to /app/perfil
    - Usage info: show WhatsApp messages used this month (from subscription data)

    All text pt-BR. Use Shadcn Card, Button, Badge.
  </action>
  <verify>
    `npx tsc --noEmit` passes. WhatsApp page renders at /app/configuracoes/whatsapp. QR code renders when code is generated. Status shows linked state.
  </verify>
  <done>
    WhatsApp settings page with phone input, QR verification flow, polling for status, and unlink option. Three verification methods: QR, deep link button, copy code.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- WhatsApp verify route generates 6-char code + deep link
- Transaction route enforces 30-message limit for free tier
- WhatsApp settings page shows verification flow
- QR code renders with deep link value
</verification>

<success_criteria>
- All 4 WhatsApp API routes functional
- Verification flow: phone input → code generation → QR/button/copy → polling → linked status
- Transaction callback encrypts data, checks tier, creates transaction
- Settings page handles all states (unlinked, verifying, linked)
</success_criteria>

<output>
After completion, create `.planning/phases/04-integrations-and-activation/04-03-SUMMARY.md`
</output>
