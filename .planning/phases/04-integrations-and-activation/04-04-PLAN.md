---
phase: 04-integrations-and-activation
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/app/app/onboarding/page.tsx
  - src/app/app/onboarding/layout.tsx
  - src/components/onboarding/onboarding-wizard.tsx
  - src/components/onboarding/welcome-step.tsx
  - src/components/onboarding/accounts-step.tsx
  - src/components/onboarding/cards-step.tsx
  - src/components/onboarding/budget-step.tsx
  - src/components/onboarding/whatsapp-step.tsx
  - src/components/onboarding/pro-step.tsx
  - src/lib/queries/onboarding.ts
  - src/app/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 6-step onboarding wizard on first login"
    - "User can skip any step or the entire onboarding"
    - "Step 1 (welcome) shows value proposition and security message"
    - "Step 2 (accounts) lets user add bank account"
    - "Step 3 (cards) lets user add credit card"
    - "Step 4 (budget) lets user set category budgets"
    - "Step 5 (WhatsApp) lets user link phone number"
    - "Step 6 (Pro) shows upgrade offer"
    - "Progress saves to profiles.onboarding_step — resume from where left off"
    - "Completing or skipping onboarding redirects to /app"
  artifacts:
    - path: "src/app/app/onboarding/page.tsx"
      provides: "Onboarding entry point"
    - path: "src/components/onboarding/onboarding-wizard.tsx"
      provides: "Step tracker with progress bar and skip"
    - path: "src/lib/queries/onboarding.ts"
      provides: "Query hooks for onboarding progress"
  key_links:
    - from: "src/app/app/layout.tsx"
      to: "src/app/app/onboarding/page.tsx"
      via: "redirect if onboarding_completed=false"
      pattern: "onboarding"
    - from: "src/components/onboarding/onboarding-wizard.tsx"
      to: "supabase profiles.onboarding_step"
      via: "update step on navigation"
      pattern: "onboarding_step"
---

<objective>
6-step onboarding wizard: welcome, bank accounts, credit cards, budget, WhatsApp, Pro offer. Progress saved in DB, skip allowed, redirects from main app layout.

Purpose: Reduce first-day churn by guiding new users through setup in < 2 minutes.
Output: Onboarding layout, wizard component, 6 step components, onboarding queries, layout redirect.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integrations-and-activation/04-02-SUMMARY.md (profile queries)
@.planning/phases/04-integrations-and-activation/04-03-SUMMARY.md (WhatsApp verification flow)
@.planning/phases/04-integrations-and-activation/04-RESEARCH.md (Pattern 4: Onboarding State)
@FUNCIONALIDADES.md (Section 3: Onboarding - 6 steps)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Onboarding wizard infrastructure + step components</name>
  <files>
    src/app/app/onboarding/page.tsx
    src/app/app/onboarding/layout.tsx
    src/components/onboarding/onboarding-wizard.tsx
    src/components/onboarding/welcome-step.tsx
    src/components/onboarding/accounts-step.tsx
    src/components/onboarding/cards-step.tsx
    src/components/onboarding/budget-step.tsx
    src/components/onboarding/whatsapp-step.tsx
    src/components/onboarding/pro-step.tsx
    src/lib/queries/onboarding.ts
  </files>
  <action>
    **src/lib/queries/onboarding.ts**: Query hooks.
    - `useOnboardingProgress()`: fetch profiles.onboarding_step and onboarding_completed for current user. staleTime: 30s.
    - `useUpdateOnboardingStep()`: mutation to update profiles.onboarding_step. Invalidate ['profile', 'onboarding'].
    - `useCompleteOnboarding()`: mutation to set onboarding_completed=true, onboarding_step=6.

    **src/app/app/onboarding/layout.tsx**: Minimal layout.
    - NO sidebar, NO bottom nav — clean full-screen wizard
    - Just QueryProvider wrapper + children
    - Background: subtle gradient or clean white

    **src/components/onboarding/onboarding-wizard.tsx**: Core wizard.
    - Props: `{ currentStep: number, children: React.ReactNode }`
    - STEPS array (6 items): boas-vindas, contas, cartoes, orcamento, whatsapp, pro
    - Progress bar at top: width = `((currentStep + 1) / STEPS.length) * 100%`, bg-primary, h-2
    - Step indicator: "Etapa {n} de 6"
    - Navigation buttons at bottom:
      - "Pular" (ghost variant) → calls completeOnboarding, redirects to /app
      - "Próximo" → increments step, saves to DB, re-renders
      - Last step: "Começar a usar" instead of "Próximo"
    - State management: currentStep tracked via URL search param or local state synced with DB
    - On mount: check profiles.onboarding_step, resume from saved step

    **src/components/onboarding/welcome-step.tsx**: Step 1 — Boas-vindas.
    - KYN logo at top
    - Heading: "Bem-vindo ao KYN"
    - Subheading: "Controle suas finanças com simplicidade"
    - 3 feature highlights with icons:
      - Sparkles: "Registre gastos pelo WhatsApp em 5 segundos"
      - ShieldCheck: "Dados criptografados — nem nós acessamos"
      - TrendingUp: "Acompanhe orçamento e evolução mensal"
    - Security message: "Seus dados são criptografados e só você tem acesso."

    **src/components/onboarding/accounts-step.tsx**: Step 2 — Contas Bancárias.
    - Heading: "Suas contas bancárias"
    - Subheading: "Adicione pelo menos uma conta para começar"
    - Reuse existing AccountForm component from src/components/accounts/account-form.tsx
    - Show list of added accounts below (mini cards)
    - "Adicionar conta" button → shows form
    - Can proceed without adding any account (optional)

    **src/components/onboarding/cards-step.tsx**: Step 3 — Cartões de Crédito.
    - Heading: "Cartões de crédito"
    - Subheading: "Adicione seus cartões para acompanhar faturas"
    - Reuse existing CardForm from src/components/cards/card-form.tsx
    - Show list of added cards below
    - Can proceed without adding any card (optional)

    **src/components/onboarding/budget-step.tsx**: Step 4 — Orçamento.
    - Heading: "Defina seu orçamento"
    - Subheading: "Quanto quer gastar por categoria este mês?"
    - List of 9 expense categories with CurrencyInput for each
    - Pre-fill with R$ 0. User fills what they want.
    - Save all at once on "Próximo"
    - Reuse budget mutation from src/lib/queries/budgets.ts if exists
    - Can proceed without setting any budget (optional)

    **src/components/onboarding/whatsapp-step.tsx**: Step 5 — WhatsApp.
    - Heading: "Vincule seu WhatsApp"
    - Subheading: "Registre transações enviando mensagens"
    - Reuse PhoneInput component from src/components/whatsapp/phone-input.tsx
    - If already linked (from earlier session): show green status
    - If not: show phone input → verification flow
    - "Registre gastos assim: 'gastei 50 no uber'" example message
    - Can proceed without linking (optional)

    **src/components/onboarding/pro-step.tsx**: Step 6 — Oferta Pro.
    - Heading: "Desbloqueie o KYN Pro"
    - Feature comparison: Free vs Pro (reuse plan data from stripe-plans)
    - Monthly + Annual upgrade buttons (reuse UpgradeButton from subscriptions)
    - "Começar grátis" as the skip/next button (changed from "Próximo")
    - Emphasis on WhatsApp ilimitado as key Pro benefit

    **src/app/app/onboarding/page.tsx**: Entry point.
    - Client component
    - Fetch onboarding progress on mount
    - If onboarding_completed → redirect to /app
    - Render OnboardingWizard with current step
    - Render appropriate step component based on currentStep index
    - Use switch/case or array lookup: [WelcomeStep, AccountsStep, CardsStep, BudgetStep, WhatsAppStep, ProStep][step]

    IMPORTANT: Reuse existing form components (AccountForm, CardForm, budget inputs) — do NOT rebuild. Wrap them in onboarding-specific layout.
    IMPORTANT: Each step is optional. User can always tap "Pular" or "Próximo" without completing the step's action.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Onboarding page renders at /app/onboarding. All 6 steps have components. Progress bar shows correct width. Skip works.
  </verify>
  <done>
    6-step onboarding wizard with progress bar, skip button, DB-persisted step. Reuses existing form components. Each step is optional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Redirect non-onboarded users from app layout</name>
  <files>
    src/app/app/layout.tsx
  </files>
  <action>
    **src/app/app/layout.tsx**: Add onboarding redirect.
    - After auth check (user exists), query profiles table for onboarding_completed
    - If `onboarding_completed === false` (or null) AND current path is NOT `/app/onboarding`:
      - `redirect('/app/onboarding')`
    - Get current path from somewhere — since this is a server component, use `headers()` to get pathname or use a different approach
    - BETTER approach: Check only in the layout, and exclude onboarding layout. Since onboarding has its own layout.tsx, the app layout check can simply:
      1. Fetch profile
      2. If not onboarding_completed → redirect('/app/onboarding')
      3. The onboarding layout does NOT do this check (it's the destination)
    - IMPORTANT: The onboarding pages live under /app/onboarding which is INSIDE the (app) route group. So the (app)/layout.tsx runs for onboarding too. Need to avoid infinite redirect loop.
    - Solution: Check if the request URL contains '/onboarding'. Use `headers()` to read the pathname, or use Next.js 15's `usePathname`... but this is a server component.
    - SIMPLEST solution: Move onboarding outside the (app) group to avoid the redirect loop. Create at `src/app/app/onboarding/layout.tsx` which overrides the parent layout.
    - OR: Use a middleware approach. Add to existing middleware or proxy.ts check.
    - RECOMMENDED: In the server layout, get the URL from headers and skip redirect if path includes 'onboarding':
      ```typescript
      const headersList = await headers()
      const pathname = headersList.get('x-pathname') || headersList.get('x-invoke-path') || ''
      ```
    - Actually simpler: just use Next.js middleware. But since proxy.ts already handles auth redirects, add onboarding check there.
    - SIMPLEST of all: Add the check in layout.tsx and pass a flag. The onboarding layout.tsx can set a different structure. Since onboarding/layout.tsx exists as a nested layout, it won't include sidebar/bottom nav, but the parent layout still runs.
    - FINAL APPROACH: In app/layout.tsx (the (app) one), after auth check:
      1. Fetch profile.onboarding_completed
      2. If false, check if we're already on onboarding path by examining the URL
      3. Use `const url = request?.url` — not available in layout
      4. Use Next.js headers: `const h = await headers(); const path = h.get('x-next-pathname') || h.get('next-url') || ''`
      5. If path doesn't include '/onboarding' → redirect('/app/onboarding')

    Keep it simple. The key requirement is: new users go to onboarding, returning users go to dashboard.
  </action>
  <verify>
    `npx tsc --noEmit` passes. New user (onboarding_completed=false) visiting /app gets redirected to /app/onboarding. User at /app/onboarding does NOT get redirected again (no loop). Returning user (onboarding_completed=true) sees dashboard normally.
  </verify>
  <done>
    Non-onboarded users redirected to /app/onboarding. No infinite redirect loop. Onboarded users access app normally.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Onboarding wizard renders 6 steps with progress bar
- Each step reuses existing form components
- Skip button completes onboarding and goes to /app
- Progress persists in profiles.onboarding_step
- Non-onboarded users redirected from /app to /app/onboarding
- No redirect loop for users already on /app/onboarding
</verification>

<success_criteria>
- 6-step onboarding wizard complete and functional
- Progress saved to DB on each step change
- Skip allowed at any point
- Existing form components reused (AccountForm, CardForm, budget inputs, phone input)
- Redirect logic prevents non-onboarded users from accessing app
</success_criteria>

<output>
After completion, create `.planning/phases/04-integrations-and-activation/04-04-SUMMARY.md`
</output>
