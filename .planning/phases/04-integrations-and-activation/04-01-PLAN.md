---
phase: 04-integrations-and-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/stripe/client.ts
  - src/lib/stripe/server.ts
  - src/app/api/stripe/checkout/route.ts
  - src/app/api/stripe/portal/route.ts
  - src/app/api/stripe/webhooks/route.ts
  - src/lib/queries/subscriptions.ts
  - src/components/subscriptions/plan-card.tsx
  - src/components/subscriptions/upgrade-button.tsx
  - src/components/subscriptions/manage-subscription.tsx
  - src/components/subscriptions/usage-meter.tsx
  - src/app/app/configuracoes/assinatura/page.tsx
  - src/types/database.ts
autonomous: true
user_setup:
  - service: stripe
    why: "Subscription billing and payment processing"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret (after creating endpoint)"
    dashboard_config:
      - task: "Create webhook endpoint pointing to /api/stripe/webhooks"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint"
      - task: "Enable events: customer.subscription.created, customer.subscription.updated, customer.subscription.deleted, invoice.payment_succeeded, invoice.payment_failed"
        location: "Stripe webhook endpoint -> Events to send"

must_haves:
  truths:
    - "User can see current subscription plan (Free/Pro) on subscription settings page"
    - "User can click upgrade button and be redirected to Stripe Checkout"
    - "User can manage existing subscription via Stripe Customer Portal link"
    - "Subscription status syncs automatically via Stripe webhooks"
    - "User sees WhatsApp message usage counter (X/30 for Free)"
  artifacts:
    - path: "src/app/api/stripe/checkout/route.ts"
      provides: "Create Stripe Checkout session"
      exports: ["POST"]
    - path: "src/app/api/stripe/webhooks/route.ts"
      provides: "Handle subscription lifecycle events"
      exports: ["POST"]
    - path: "src/app/api/stripe/portal/route.ts"
      provides: "Create Stripe Customer Portal session"
      exports: ["POST"]
    - path: "src/lib/queries/subscriptions.ts"
      provides: "TanStack Query hooks for subscription data"
    - path: "src/app/app/configuracoes/assinatura/page.tsx"
      provides: "Subscription management page"
  key_links:
    - from: "src/components/subscriptions/upgrade-button.tsx"
      to: "/api/stripe/checkout"
      via: "fetch POST with priceId"
      pattern: "fetch.*api/stripe/checkout"
    - from: "src/app/api/stripe/webhooks/route.ts"
      to: "supabase subscriptions table"
      via: "update plan/status on webhook event"
      pattern: "supabase.*subscriptions.*update"
---

<objective>
Stripe subscription integration: install SDK, create checkout/portal/webhook API routes, build subscription management UI page with plan cards, upgrade button, and usage meter.

Purpose: Monetization infrastructure — users can upgrade to Pro, subscription syncs via webhooks, free tier limits enforced.
Output: 3 API routes, subscription queries, 4 UI components, subscription settings page.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@reference/stripe-plans.ts
@supabase/001_schema.sql (subscriptions table lines 188-201)
@.planning/phases/04-integrations-and-activation/04-RESEARCH.md (Pattern 3: Stripe)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stripe SDK + API Routes (checkout, portal, webhooks)</name>
  <files>
    package.json
    src/lib/stripe/client.ts
    src/lib/stripe/server.ts
    src/app/api/stripe/checkout/route.ts
    src/app/api/stripe/portal/route.ts
    src/app/api/stripe/webhooks/route.ts
    src/types/database.ts
  </files>
  <action>
    Install: `npm install stripe @stripe/stripe-js`

    **src/lib/stripe/server.ts**: Create server-side Stripe instance.
    - `new Stripe(process.env.STRIPE_SECRET_KEY!, { apiVersion: '2024-12-18.acacia' })`
    - Export as default `stripe`

    **src/lib/stripe/client.ts**: Create client-side Stripe loader.
    - `loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)` with lazy init
    - Export `getStripe()` function

    **src/app/api/stripe/checkout/route.ts**: POST handler.
    - Auth check via supabase.auth.getUser()
    - Accept `{ priceId }` in body
    - Get/create Stripe customer: check `subscriptions.stripe_customer_id`, if null create customer with email + metadata.user_id, upsert stripe_customer_id
    - Create checkout session: mode='subscription', success_url=`/app?upgrade=success`, cancel_url=`/app/configuracoes/assinatura?upgrade=canceled`
    - Return `{ url: session.url }`

    **src/app/api/stripe/portal/route.ts**: POST handler.
    - Auth check, get stripe_customer_id from subscriptions table
    - Create billingPortal session, return_url = `/app/configuracoes/assinatura`
    - Return `{ url: session.url }`

    **src/app/api/stripe/webhooks/route.ts**: POST handler.
    - Read raw body with `request.text()`, get signature from headers
    - Verify with `stripe.webhooks.constructEvent()` — return 400 if invalid
    - Use admin Supabase client (service role) for DB updates — webhooks have no user session
    - Import createClient from `@supabase/supabase-js` directly with SUPABASE_SERVICE_ROLE_KEY
    - Handle events:
      - `customer.subscription.created/updated`: update plan (map price to plan name via lookup), status, stripe_subscription_id, current_period_end. Map price IDs: price_1StGj0IYuOEaGzogx8HO8Hi1 → 'pro', price_1StGkmIYuOEaGzogcKuLfbqn → 'pro_annual'
      - `customer.subscription.deleted`: set plan='free', status='canceled', stripe_subscription_id=null
      - `invoice.payment_succeeded`: reset whatsapp_messages_used=0
    - Return `{ received: true }`

    **src/types/database.ts**: Add `user_whatsapp_links` table type (Row/Insert/Update) with fields: id, user_id, phone_number, whatsapp_lid, verification_code, verification_expires_at, verified_at, created_at. This is needed by later plans.

    IMPORTANT: Webhook route must NOT use Next.js `headers()` for body — must use `request.text()` for raw body. Stripe signature verification requires raw body string.
    IMPORTANT: Webhook route needs `export const runtime = 'nodejs'` and must NOT parse JSON before constructing event.
  </action>
  <verify>
    `npx tsc --noEmit` passes. All 3 route files export POST. Stripe imported without errors. `npm ls stripe @stripe/stripe-js` shows both installed.
  </verify>
  <done>
    Stripe SDK installed. Checkout creates session with redirect URL. Portal creates session. Webhooks verify signature and update subscriptions table. user_whatsapp_links type added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Subscription UI — queries, components, settings page</name>
  <files>
    src/lib/queries/subscriptions.ts
    src/components/subscriptions/plan-card.tsx
    src/components/subscriptions/upgrade-button.tsx
    src/components/subscriptions/manage-subscription.tsx
    src/components/subscriptions/usage-meter.tsx
    src/app/app/configuracoes/assinatura/page.tsx
  </files>
  <action>
    **src/lib/queries/subscriptions.ts**: TanStack Query hooks.
    - `useSubscription()`: fetch from subscriptions table where user_id = current user. Select plan, status, whatsapp_messages_used, whatsapp_messages_reset_at, current_period_end, stripe_customer_id. staleTime: 5min.
    - `useUpgrade()`: mutation that POSTs to /api/stripe/checkout with priceId, then `window.location.href = data.url` for redirect
    - `useManageSubscription()`: mutation that POSTs to /api/stripe/portal, then `window.location.href = data.url`

    **src/components/subscriptions/plan-card.tsx**: Display plan comparison.
    - Props: plan from `reference/stripe-plans.ts` PLANS constant (import it to src/lib)
    - Show plan name, price (formatCurrency), feature list with checkmarks
    - Highlight current plan with border-primary
    - "Popular" badge on Pro plan
    - Import PLANS from a new `src/lib/plans.ts` that re-exports from reference/stripe-plans.ts patterns (copy the data, don't import from reference/)

    **src/components/subscriptions/upgrade-button.tsx**: CTA button.
    - Shows "Fazer Upgrade" for free users, "Plano Atual" (disabled) for Pro
    - Accepts priceId prop, calls useUpgrade mutation on click
    - Loading state while redirecting
    - Two variants: monthly (R$ 19,90/mês) and annual (R$ 179,90/ano)

    **src/components/subscriptions/manage-subscription.tsx**: Portal link.
    - Only visible for Pro users (has stripe_customer_id)
    - "Gerenciar Assinatura" button → calls useManageSubscription
    - Shows current_period_end as "Próxima cobrança: DD/MM/YYYY"

    **src/components/subscriptions/usage-meter.tsx**: WhatsApp usage.
    - Shows "X/30 mensagens WhatsApp" for free users
    - Progress bar (green < 20, yellow 20-25, red > 25)
    - "Ilimitado" badge for Pro users
    - Reset date info

    **src/app/app/configuracoes/assinatura/page.tsx**: Settings page.
    - Title "Assinatura"
    - Current plan card at top
    - If free: show Pro monthly + Pro annual plan cards with upgrade buttons
    - If pro: show manage subscription button + next billing date
    - Usage meter at bottom
    - Back button to /app/perfil (or /app/configuracoes)

    All text in pt-BR. Use Shadcn Card, Button, Badge, Progress components.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Subscription page renders plan cards. Free users see upgrade options. Pro users see manage button.
  </verify>
  <done>
    Subscription page at /app/configuracoes/assinatura shows current plan, upgrade options for free users, management for pro users, and WhatsApp usage meter.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `/api/stripe/checkout` route exports POST handler
- `/api/stripe/webhooks` route verifies signatures
- `/api/stripe/portal` route creates portal session
- Subscription page renders at /app/configuracoes/assinatura
- Plan cards show Free, Pro, Pro Annual with correct prices
</verification>

<success_criteria>
- Stripe SDK installed and configured (server + client)
- 3 API routes handle checkout, portal, and webhooks
- Webhook handler updates subscriptions table for all relevant events
- Subscription settings page shows current plan and upgrade options
- Usage meter displays WhatsApp message count
</success_criteria>

<output>
After completion, create `.planning/phases/04-integrations-and-activation/04-01-SUMMARY.md`
</output>
