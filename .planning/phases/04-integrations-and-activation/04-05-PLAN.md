---
phase: 04-integrations-and-activation
plan: 05
type: execute
wave: 1
depends_on: ["04-04"]
files_modified:
  - src/components/onboarding/onboarding-gate.tsx
  - src/app/app/layout.tsx
  - src/app/app/page.tsx
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Non-onboarded user navigating to /app/carteira gets redirected to /app/onboarding"
    - "Non-onboarded user navigating to /app gets redirected to /app/onboarding"
    - "User already on /app/onboarding does NOT get redirect loop"
    - "Onboarded user navigates freely without redirect"
    - "Stripe webhook events update subscription in Supabase"
  artifacts:
    - path: "src/components/onboarding/onboarding-gate.tsx"
      provides: "Client component that checks onboarding status and redirects"
      contains: "usePathname"
    - path: "src/app/app/layout.tsx"
      provides: "Layout wrapping children with OnboardingGate"
      contains: "OnboardingGate"
  key_links:
    - from: "src/app/app/layout.tsx"
      to: "src/components/onboarding/onboarding-gate.tsx"
      via: "component import and render"
      pattern: "OnboardingGate"
    - from: "src/components/onboarding/onboarding-gate.tsx"
      to: "/app/onboarding"
      via: "router.push when onboarding_completed=false"
      pattern: "router\\.push.*onboarding"
---

<objective>
Close 2 verification gaps from Phase 4:
1. (BLOCKER) Add onboarding redirect to app layout so ALL /app/* routes enforce onboarding completion
2. (PARTIAL) Human-verify Stripe webhook sync reaches Supabase

Purpose: Without layout-level redirect, users can bypass onboarding by navigating directly to /app/carteira, /app/orcamento, etc. The current check only exists in /app/page.tsx (dashboard). Also need human confirmation that Stripe webhooks actually update the DB.

Output: OnboardingGate component in layout.tsx + verified Stripe sync
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integrations-and-activation/04-04-SUMMARY.md

Key existing code:
- src/app/app/layout.tsx — Server component, has auth check + redirect to /login. Missing onboarding check.
- src/app/app/page.tsx — Client component, has useEffect redirect to /app/onboarding (lines 30-34). This only covers dashboard, NOT other routes.
- src/lib/queries/onboarding.ts — useOnboardingProgress hook (already exists, queries profiles.onboarding_completed)
- src/app/app/onboarding/layout.tsx — Separate layout for onboarding (no sidebar/nav)
- src/app/api/stripe/webhooks/route.ts — Webhook handler with .update() calls for subscription sync
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OnboardingGate to app layout for global redirect</name>
  <files>
    src/components/onboarding/onboarding-gate.tsx
    src/app/app/layout.tsx
    src/app/app/page.tsx
  </files>
  <action>
    Create `src/components/onboarding/onboarding-gate.tsx` — a 'use client' component that:
    - Uses `usePathname()` from next/navigation to get current path
    - Uses `useOnboardingProgress()` from @/lib/queries/onboarding (already exists)
    - Uses `useRouter()` for programmatic navigation
    - In useEffect: if `onboardingProgress` is loaded AND `onboarding_completed === false` AND pathname does NOT start with `/app/onboarding`, call `router.push('/app/onboarding')`
    - Renders `{children}` always (no loading gate — the redirect is non-blocking, same as current page.tsx pattern)
    - Props: `{ children: React.ReactNode }`

    Modify `src/app/app/layout.tsx`:
    - Import OnboardingGate
    - Wrap `{children}` with `<OnboardingGate>{children}</OnboardingGate>` inside the QueryProvider
    - Keep the existing server-side auth check (redirect to /login if no user) unchanged

    Modify `src/app/app/page.tsx`:
    - REMOVE the duplicate onboarding redirect useEffect (lines 8, 22, 29-34) since it's now handled globally by OnboardingGate in layout
    - Remove the `useOnboardingProgress` import and usage from this file
    - Keep everything else (dashboard rendering, month selector, transactions, etc.)

    Why client component for gate: Next.js App Router server layouts cannot access pathname. usePathname() is client-only. The existing pattern (useEffect redirect) is already used in page.tsx — we're elevating it to layout level.

    Why NOT middleware: No middleware.ts exists. Adding middleware for just this check adds complexity. The client-side pattern is consistent with existing codebase decisions (see STATE.md: "Client-side onboarding redirect (04-04)").
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. `grep -r "OnboardingGate" src/app/app/layout.tsx` shows import and usage
    3. `grep -r "useOnboardingProgress" src/app/app/page.tsx` returns nothing (removed)
    4. `grep -r "usePathname" src/components/onboarding/onboarding-gate.tsx` shows pathname check
  </verify>
  <done>
    - OnboardingGate component exists with pathname exclusion for /app/onboarding
    - Layout.tsx wraps children with OnboardingGate
    - page.tsx no longer has duplicate redirect logic
    - Any /app/* route redirects non-onboarded users to /app/onboarding
    - /app/onboarding itself does NOT trigger redirect loop
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Stripe webhook sync and onboarding redirect</name>
  <files>src/app/api/stripe/webhooks/route.ts</files>
  <action>
    Human verification of two items:
    1. OnboardingGate redirect works on ALL /app/* routes (not just dashboard)
    2. Stripe webhook handler actually syncs subscription data to Supabase

    **Onboarding redirect (test in browser):**
    - Create new user OR set existing user's profiles.onboarding_completed=false in Supabase Dashboard
    - Navigate to /app/carteira — should redirect to /app/onboarding
    - Navigate to /app/orcamento — should redirect to /app/onboarding
    - Navigate to /app/onboarding — should stay (no loop)
    - Complete onboarding, navigate to /app/carteira — should stay

    **Stripe webhook sync (if Stripe configured):**
    - In Stripe Dashboard, Developers, Webhooks — verify endpoint exists
    - Send test event `customer.subscription.updated` from Stripe Dashboard
    - Check Supabase subscriptions table — plan/status should update
    - If Stripe not configured yet: type "stripe-deferred" to skip
  </action>
  <verify>Human confirms redirect works on all routes + Stripe webhook updates DB (or deferred)</verify>
  <done>Phase 4 verification score moves from 7/9 to 9/9 (or 8/9 + 1 deferred)</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. OnboardingGate imported and rendered in layout.tsx
3. No duplicate onboarding check in page.tsx
4. Onboarding redirect works on ALL /app/* routes (not just dashboard)
5. No redirect loop on /app/onboarding
</verification>

<success_criteria>
- Non-onboarded users cannot access any /app/* route without being redirected to onboarding
- Onboarded users see no difference in behavior
- No redirect loop on /app/onboarding path
- Stripe webhook code confirmed functional (human verified or deferred)
- Phase 4 verification score moves from 7/9 to 9/9 (or 8/9 + 1 deferred)
</success_criteria>

<output>
After completion, create `.planning/phases/04-integrations-and-activation/04-05-SUMMARY.md`
</output>
