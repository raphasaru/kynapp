---
phase: 03-analysis-and-automation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/aggregations/chart-data.ts
  - src/lib/aggregations/date-ranges.ts
  - src/components/charts/expense-pie-chart.tsx
  - src/components/charts/income-expense-bars.tsx
  - src/components/charts/report-summary.tsx
  - src/app/(app)/relatorios/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees pie chart of expenses by category for selected month"
    - "User sees bar chart of income vs expenses for last 6 months"
    - "User sees summary: total received, total paid, projected balance"
  artifacts:
    - path: "src/lib/aggregations/chart-data.ts"
      provides: "Transform transactions into Recharts-compatible data formats"
      exports: ["getExpenseByCategoryData", "getIncomeExpenseByMonth"]
    - path: "src/lib/aggregations/date-ranges.ts"
      provides: "Last 6 months range generation"
      exports: ["getLast6Months", "getMonthRange"]
    - path: "src/components/charts/expense-pie-chart.tsx"
      provides: "Pie chart of expenses by category"
    - path: "src/components/charts/income-expense-bars.tsx"
      provides: "Bar chart of income vs expenses (6 months)"
    - path: "src/components/charts/report-summary.tsx"
      provides: "Summary cards: received, paid, projected balance"
    - path: "src/app/(app)/relatorios/page.tsx"
      provides: "Reports page with charts and summary"
  key_links:
    - from: "src/components/charts/expense-pie-chart.tsx"
      to: "src/lib/aggregations/chart-data.ts"
      via: "getExpenseByCategoryData transform"
      pattern: "getExpenseByCategoryData"
    - from: "src/components/charts/income-expense-bars.tsx"
      to: "src/lib/aggregations/chart-data.ts"
      via: "getIncomeExpenseByMonth transform"
      pattern: "getIncomeExpenseByMonth"
    - from: "src/app/(app)/relatorios/page.tsx"
      to: "src/lib/queries/transactions.ts"
      via: "useTransactions for each month"
      pattern: "useTransactions"
---

<objective>
Historical reports with pie chart (expenses by category), bar chart (income vs expenses 6 months), and financial summary.

Purpose: Users need visual insight into spending patterns and income/expense trends to make better financial decisions.
Output: Working /app/relatorios page with interactive charts and summary cards.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-analysis-and-automation/03-RESEARCH.md
@.planning/phases/03-analysis-and-automation/03-01-SUMMARY.md
@src/lib/queries/transactions.ts
@src/lib/formatters/currency.ts
@src/lib/formatters/date.ts
@src/hooks/use-month-selector.ts
@src/components/dashboard/month-selector.tsx
@reference/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chart data aggregation utilities</name>
  <files>
    src/lib/aggregations/chart-data.ts
    src/lib/aggregations/date-ranges.ts
  </files>
  <action>
1. Create src/lib/aggregations/date-ranges.ts:
   - `getLast6Months(): { month: string; label: string }[]` — returns array of 6 objects from 5 months ago to current month. month = 'yyyy-MM' format, label = short month name via date-fns format(date, 'MMM yy', { locale: ptBR }). Example: [{month:'2025-09', label:'Set 25'}, ..., {month:'2026-02', label:'Fev 26'}].
   - Re-export getMonthRange from src/lib/formatters/date.ts for convenience (single import point for aggregation code).

2. Create src/lib/aggregations/chart-data.ts:
   - Import DecryptedTransaction from queries/transactions, categoryLabels from reference/categories.
   - `getExpenseByCategoryData(transactions: DecryptedTransaction[]): { name: string; value: number; category: string }[]` — filters completed expenses, groups by category, sums amounts per category, maps to Recharts-compatible [{name: categoryLabel, value: total, category: enum_key}]. Sort descending by value. Exclude categories with 0 spending.
   - `getIncomeExpenseByMonth(transactionsByMonth: Map<string, DecryptedTransaction[]>, months: { month: string; label: string }[]): { month: string; income: number; expense: number }[]` — for each month in months array, sum income and expense from completed transactions. Returns array for BarChart. Use the months labels directly for x-axis.
   - `getReportSummary(transactions: DecryptedTransaction[]): { totalReceived: number; totalPaid: number; projectedBalance: number }` — totalReceived = sum income (completed), totalPaid = sum expense (completed), projectedBalance = sum all income - sum all expenses (including planned) for the month.
   - Use CHART_COLORS constant: ['#10b77f', '#6366f1', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#2cedac', '#64748b'] — 9 colors for 9 categories.
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Chart data utilities transform decrypted transactions into Recharts-compatible formats. Date range utility generates last 6 months with pt-BR labels.</done>
</task>

<task type="auto">
  <name>Task 2: Chart components + reports page</name>
  <files>
    src/components/charts/expense-pie-chart.tsx
    src/components/charts/income-expense-bars.tsx
    src/components/charts/report-summary.tsx
    src/app/(app)/relatorios/page.tsx
  </files>
  <action>
1. Create src/components/charts/expense-pie-chart.tsx — 'use client':
   - Props: transactions (DecryptedTransaction[])
   - Use useMemo + getExpenseByCategoryData to transform data.
   - Render: ResponsiveContainer width="100%" height={300}, PieChart > Pie with dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} label showing category name. Cell components with CHART_COLORS fill. Tooltip with formatCurrency formatter. Legend at bottom.
   - Empty state: if no expense data, show "Nenhuma despesa registrada neste periodo" centered text.
   - Add aria-label="Grafico de despesas por categoria" on container.

2. Create src/components/charts/income-expense-bars.tsx — 'use client':
   - Props: transactionsByMonth (Map<string, DecryptedTransaction[]>)
   - Use useMemo + getLast6Months + getIncomeExpenseByMonth to build chart data.
   - Render: ResponsiveContainer width="100%" height={300}, BarChart > CartesianGrid strokeDasharray="3 3", XAxis dataKey="month", YAxis (hide on mobile via useMediaQuery), Tooltip with formatCurrency, Legend. Two Bar components: dataKey="income" fill="#10b77f" name="Receitas", dataKey="expense" fill="#ef4444" name="Despesas".
   - Add aria-label="Grafico de receitas vs despesas".

3. Create src/components/charts/report-summary.tsx — 'use client':
   - Props: totalReceived (number), totalPaid (number), projectedBalance (number)
   - Three Card components in grid (same pattern as BalanceCards): "Total Recebido" (green), "Total Pago" (red), "Saldo Projetado" (green if positive, red if negative).
   - Use formatCurrency for all values.

4. Create src/app/(app)/relatorios/page.tsx — 'use client':
   - Use useMonthSelector() for current month context.
   - Fetch current month transactions via useTransactions(month).
   - For bar chart: fetch last 6 months of transactions. Use getLast6Months() to get month strings. Call useTransactions for each month (TanStack Query handles caching). Build Map<string, DecryptedTransaction[]>.
   - IMPORTANT: To avoid 6 separate queries, create a `useMultiMonthTransactions(months: string[])` inline using useQueries from TanStack Query. Each query uses same logic as useTransactions but with different month param.
   - Layout:
     - Header: "Relatorios" title + MonthSelector (for pie chart month selection)
     - ReportSummary (current month)
     - Card wrapper: "Despesas por Categoria" heading + ExpensePieChart (current month)
     - Card wrapper: "Receitas vs Despesas" heading + IncomeExpenseBars (last 6 months)
   - Loading: skeleton for each chart section.
   - Note on free tier: research mentions free tier = 3 months history. For now build with 6 months — free tier enforcement will happen in Phase 4 (SUBS integration). Show whatever data exists.
  </action>
  <verify>npm run build passes. /app/relatorios renders with charts. Charts resize responsively.</verify>
  <done>Reports page shows pie chart (expenses by category), bar chart (6-month income vs expenses), and summary (received/paid/projected). HIST-01 through HIST-03 covered.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- /app/relatorios accessible from bottom nav "Relatorios" link
- Pie chart renders with category colors and labels
- Bar chart shows 6 months with income (green) and expense (red) bars
- Summary cards show total received, total paid, projected balance
- Charts responsive (ResponsiveContainer) with explicit height
- Empty states display when no data
</verification>

<success_criteria>
1. Pie chart shows expense breakdown by category for selected month
2. Bar chart shows income vs expenses trend for last 6 months
3. Summary cards display total received, total paid, projected balance
4. Charts are responsive and accessible (aria-labels)
5. Month selector controls the pie chart and summary period
</success_criteria>

<output>
After completion, create `.planning/phases/03-analysis-and-automation/03-03-SUMMARY.md`
</output>
