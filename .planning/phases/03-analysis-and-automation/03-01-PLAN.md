---
phase: 03-analysis-and-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/database.ts
  - src/lib/queries/budgets.ts
  - src/lib/validators/budget.ts
  - src/lib/aggregations/budget-calc.ts
  - src/components/budgets/budget-progress.tsx
  - src/components/budgets/budget-card.tsx
  - src/components/budgets/budget-summary.tsx
  - src/components/budgets/budget-form.tsx
  - src/app/(app)/orcamento/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can set monthly spending limit per category"
    - "User sees progress bar per category (green/yellow/red)"
    - "User sees total budgeted, spent, and remaining for month"
    - "User can edit budget limits for all categories at once"
  artifacts:
    - path: "src/types/database.ts"
      provides: "TypeScript types for category_budgets and recurring_templates tables"
      contains: "category_budgets"
    - path: "src/lib/queries/budgets.ts"
      provides: "TanStack Query hooks for budget CRUD"
      exports: ["useBudgets", "useUpsertBudgets"]
    - path: "src/lib/aggregations/budget-calc.ts"
      provides: "Client-side budget aggregation (spent per category, progress color)"
      exports: ["calculateCategorySpending", "getBudgetProgress"]
    - path: "src/lib/validators/budget.ts"
      provides: "Zod schema for budget form"
      exports: ["budgetSchema"]
    - path: "src/components/budgets/budget-progress.tsx"
      provides: "Progress bar with green/yellow/red thresholds"
    - path: "src/components/budgets/budget-card.tsx"
      provides: "Single category budget card with progress"
    - path: "src/components/budgets/budget-summary.tsx"
      provides: "Total budgeted/spent/remaining summary"
    - path: "src/components/budgets/budget-form.tsx"
      provides: "Edit all category limits at once"
    - path: "src/app/(app)/orcamento/page.tsx"
      provides: "Budget page with month selector"
  key_links:
    - from: "src/components/budgets/budget-card.tsx"
      to: "src/lib/aggregations/budget-calc.ts"
      via: "calculateCategorySpending + getBudgetProgress"
      pattern: "calculateCategorySpending|getBudgetProgress"
    - from: "src/app/(app)/orcamento/page.tsx"
      to: "src/lib/queries/budgets.ts"
      via: "useBudgets hook"
      pattern: "useBudgets"
    - from: "src/app/(app)/orcamento/page.tsx"
      to: "src/lib/queries/transactions.ts"
      via: "useTransactions for spending calculation"
      pattern: "useTransactions"
---

<objective>
Budget management with category spending limits, progress visualization, and month-aware aggregation.

Purpose: Users need to set spending limits per category and see at-a-glance how much they've spent vs budgeted — the core "am I on track?" feedback loop.
Output: Working /app/orcamento page with category budget cards, progress bars, summary, and edit form.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-analysis-and-automation/03-RESEARCH.md
@src/types/database.ts
@src/lib/queries/transactions.ts
@src/lib/crypto/encrypt.ts
@src/lib/formatters/currency.ts
@src/lib/formatters/date.ts
@src/hooks/use-month-selector.ts
@src/hooks/use-media-query.ts
@src/components/dashboard/balance-cards.tsx
@src/lib/validators/transaction.ts
@reference/categories.ts
@reference/encryption-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database types + budget queries/validators/aggregation</name>
  <files>
    src/types/database.ts
    src/lib/queries/budgets.ts
    src/lib/validators/budget.ts
    src/lib/aggregations/budget-calc.ts
  </files>
  <action>
1. Update src/types/database.ts — add `category_budgets` and `recurring_templates` table types to Database['public']['Tables']. category_budgets Row: id (string), user_id (string), category (string|null), custom_category_id (string|null), monthly_budget (string — encrypted), created_at (string), updated_at (string). recurring_templates Row: id (string), user_id (string), description (string), amount (string), type ('income'|'expense'), category (string|null), custom_category_id (string|null), day_of_month (number), is_active (boolean), payment_method (string|null), bank_account_id (string|null), credit_card_id (string|null), created_at (string|null), updated_at (string|null). Add Insert/Update variants following existing pattern. Also add missing fields to transactions Row/Insert/Update: recurring_day (number|null), recurring_group_id (string|null), recurring_end_date (string|null), custom_category_id (string|null).

2. Create src/lib/validators/budget.ts — Zod schema for budget form. Schema: `budgetFormSchema` = z.object with `budgets` array of z.object({ category: z.string(), monthly_budget: z.number().min(0) }). Export type `BudgetFormInput`.

3. Create src/lib/queries/budgets.ts — TanStack Query hooks following transactions.ts pattern:
   - `DecryptedBudget` type: Omit monthly_budget from Row, add monthly_budget as number
   - `useBudgets()`: fetches all category_budgets for current user, decrypts monthly_budget, returns array. queryKey: ['budgets'].
   - `useUpsertBudgets()`: mutation that takes array of {category, monthly_budget}. For each item: encrypt monthly_budget, upsert into category_budgets (match on user_id + category). On success invalidate ['budgets']. Use getUser() for user_id.

4. Create src/lib/aggregations/budget-calc.ts:
   - `calculateCategorySpending(transactions: DecryptedTransaction[], category: string): number` — filters expenses with status='completed' matching category, sums amounts.
   - `getBudgetProgress(spent: number, limit: number): { percent: number; color: 'green' | 'yellow' | 'red' }` — green 0-75%, yellow 75-90%, red 90%+. Cap percent at 100 for display but track actual for label.
   - `calculateBudgetSummary(transactions: DecryptedTransaction[], budgets: DecryptedBudget[]): { totalBudgeted: number; totalSpent: number; remaining: number }` — sums all budget limits and all category spending.
  </action>
  <verify>npx tsc --noEmit passes with no errors on new files</verify>
  <done>Database types include category_budgets + recurring_templates. Budget queries fetch/upsert with encryption. Aggregation utils calculate spending per category with color thresholds.</done>
</task>

<task type="auto">
  <name>Task 2: Budget UI components</name>
  <files>
    src/components/budgets/budget-progress.tsx
    src/components/budgets/budget-card.tsx
    src/components/budgets/budget-summary.tsx
    src/components/budgets/budget-form.tsx
  </files>
  <action>
1. Create src/components/budgets/budget-progress.tsx — Reusable progress bar component:
   - Props: spent (number), limit (number), showLabel (boolean, default true)
   - Calculate percent and color via getBudgetProgress()
   - Render: div with h-2 rounded-full bg-secondary, inner div with width=percent%, color classes: green=bg-[#10b77f], yellow=bg-amber-500 (NOT pure yellow — accessibility), red=bg-red-500. transition-all duration-500.
   - If showLabel: flex justify-between text-sm — left: "R$ {spent} de R$ {limit}" via formatCurrency, right: percent with color text class.

2. Create src/components/budgets/budget-card.tsx — Single category budget display:
   - Props: category (string), spent (number), limit (number)
   - Show category icon (from categoryIcons map) + label (from categoryLabels map) using Lucide dynamic import or a mapping component.
   - Show BudgetProgress below.
   - Use Card from shadcn. Compact layout: icon + label on left, spent/limit on right, progress bar below.

3. Create src/components/budgets/budget-summary.tsx — Total overview:
   - Props: totalBudgeted (number), totalSpent (number), remaining (number)
   - Three-column grid (like BalanceCards pattern): "Total Orçado", "Total Gasto", "Restante"
   - Color remaining: green if positive, red if negative. Use formatCurrency.

4. Create src/components/budgets/budget-form.tsx — Edit all categories at once:
   - Uses React Hook Form + Zod (budgetFormSchema)
   - Shows all 9 expense_category enums in a list, each with label + currency input
   - Pre-fills from existing budgets (pass as prop)
   - Submit calls useUpsertBudgets mutation
   - Wrap in Sheet on mobile, Dialog on desktop (useMediaQuery pattern from Phase 2)
   - Button text: "Salvar Orçamento"
   - Currency input: type="number" step="0.01" min="0", placeholder "R$ 0,00"
  </action>
  <verify>npx tsc --noEmit — no type errors. Components render without crashes.</verify>
  <done>All 4 budget components created with proper typing, progress colors, responsive form.</done>
</task>

<task type="auto">
  <name>Task 3: Budget page (/app/orcamento)</name>
  <files>src/app/(app)/orcamento/page.tsx</files>
  <action>
Create src/app/(app)/orcamento/page.tsx — 'use client' page:
1. Use useMonthSelector() for month navigation (reuse MonthSelector component from dashboard).
2. Use useTransactions(month) to get current month's transactions.
3. Use useBudgets() to get all budget limits.
4. Use useMemo to calculate: spent per category via calculateCategorySpending, summary via calculateBudgetSummary.
5. Layout:
   - Header: "Orçamento" title + MonthSelector
   - BudgetSummary at top (3-col cards)
   - Grid of BudgetCard for each category that has a budget set (skip categories with limit=0 and no spending)
   - If no budgets set: empty state with "Defina seus limites de gastos por categoria" + button to open form
   - FAB or header button: "Editar Limites" opens BudgetForm
6. Filter: only show expense categories (budget doesn't apply to income).
7. Import MonthSelector from '@/components/dashboard/month-selector' (already exists from Phase 2).
  </action>
  <verify>npm run build passes. Page renders at /app/orcamento with month selector, budget cards, summary, and edit form.</verify>
  <done>Budget page shows progress bars per category (green/yellow/red), summary totals, and allows editing all limits at once. Reqs BUDG-01 through BUDG-04 covered.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- /app/orcamento page accessible from bottom nav "Orçamento" link
- Budget form opens and saves limits
- Progress bars show correct colors (green < 75%, yellow 75-90%, red > 90%)
- Summary shows total budgeted, total spent, remaining
</verification>

<success_criteria>
1. User can navigate to /app/orcamento and see budget overview for selected month
2. User can set/edit monthly spending limits for all categories at once
3. Progress bars show green/yellow/red based on spending vs limit thresholds
4. Summary card shows total budgeted, total spent, remaining
5. Month selector navigates between months (URL-based state)
</success_criteria>

<output>
After completion, create `.planning/phases/03-analysis-and-automation/03-01-SUMMARY.md`
</output>
