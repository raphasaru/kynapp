---
phase: 01-foundation-security
plan: 04
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/manifest.ts
  - public/sw.js
  - public/offline.html
  - src/app/(app)/layout.tsx
  - src/app/(app)/page.tsx
  - src/components/navigation/bottom-nav.tsx
  - src/components/navigation/sidebar.tsx
  - src/components/navigation/nav-items.ts
autonomous: true

must_haves:
  truths:
    - "App is installable as PWA on mobile and desktop"
    - "Mobile viewport shows bottom navigation with 5 tabs"
    - "Desktop viewport shows sidebar navigation"
    - "Offline fallback page displays when no network"
    - "manifest.ts generates valid PWA manifest at /manifest.webmanifest"
    - "Visiting /app while authenticated shows app shell with navigation"
  artifacts:
    - path: "src/app/manifest.ts"
      provides: "PWA manifest generation"
      exports: ["default"]
    - path: "public/sw.js"
      provides: "Service worker with cache-first for assets"
    - path: "src/app/(app)/layout.tsx"
      provides: "Authenticated app layout with responsive nav"
    - path: "src/components/navigation/bottom-nav.tsx"
      provides: "Mobile bottom navigation (5 tabs)"
    - path: "src/components/navigation/sidebar.tsx"
      provides: "Desktop sidebar navigation"
  key_links:
    - from: "src/app/manifest.ts"
      to: "public/icons/*"
      via: "icon references in manifest"
      pattern: "icons/icon"
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/navigation/bottom-nav.tsx"
      via: "conditional render by viewport"
      pattern: "BottomNav|Sidebar"
    - from: "public/sw.js"
      to: "public/offline.html"
      via: "fallback on network failure"
      pattern: "offline\\.html"
---

<objective>
Set up PWA configuration (manifest.ts, service worker, offline fallback) and create the authenticated app shell with responsive navigation (bottom nav on mobile, sidebar on desktop).

Purpose: PWA installability is a core feature. The app shell provides the navigation structure that all future app pages will live inside.
Output: Installable PWA with offline support, app shell with responsive navigation ready for Phase 2 content.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-security/01-02-SUMMARY.md
@design-system.html
@public/manifest.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure PWA manifest, service worker, and offline support</name>
  <files>
    src/app/manifest.ts
    public/sw.js
    public/offline.html
    src/app/layout.tsx
  </files>
  <action>
    1. Create `src/app/manifest.ts` (replaces static public/manifest.json — Next.js native):
    ```typescript
    import type { MetadataRoute } from 'next'

    export default function manifest(): MetadataRoute.Manifest {
      return {
        name: 'KYN - Finanças Pessoais',
        short_name: 'KYN',
        description: 'Gestão financeira pessoal simples e segura. Registre gastos pelo WhatsApp.',
        start_url: '/app',
        display: 'standalone',
        background_color: '#070b14',
        theme_color: '#10b77f',
        orientation: 'portrait',
        lang: 'pt-BR',
        categories: ['finance', 'productivity'],
        icons: [
          {
            src: '/icons/icon-192.png',
            sizes: '192x192',
            type: 'image/png',
            purpose: 'maskable',
          },
          {
            src: '/icons/icon-512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any',
          },
        ],
      }
    }
    ```

    2. Delete `public/manifest.json` (superseded by manifest.ts which generates /manifest.webmanifest automatically).

    3. Create `public/sw.js` — basic service worker with cache-first for static assets and network-first for API:
    ```javascript
    const CACHE_NAME = 'kyn-v1'
    const STATIC_ASSETS = [
      '/offline.html',
      '/icons/icon-192.png',
      '/icons/icon-512.png',
    ]

    // Install: cache static assets
    self.addEventListener('install', (event) => {
      event.waitUntil(
        caches.open(CACHE_NAME).then((cache) => cache.addAll(STATIC_ASSETS))
      )
      self.skipWaiting()
    })

    // Activate: clean old caches
    self.addEventListener('activate', (event) => {
      event.waitUntil(
        caches.keys().then((keys) =>
          Promise.all(keys.filter((k) => k !== CACHE_NAME).map((k) => caches.delete(k)))
        )
      )
      self.clients.claim()
    })

    // Fetch: network-first for navigation, cache-first for static assets
    self.addEventListener('fetch', (event) => {
      if (event.request.mode === 'navigate') {
        event.respondWith(
          fetch(event.request).catch(() => caches.match('/offline.html'))
        )
        return
      }

      // Cache-first for static assets
      if (event.request.destination === 'image' ||
          event.request.destination === 'style' ||
          event.request.destination === 'script') {
        event.respondWith(
          caches.match(event.request).then((cached) =>
            cached || fetch(event.request).then((response) => {
              const clone = response.clone()
              caches.open(CACHE_NAME).then((cache) => cache.put(event.request, clone))
              return response
            })
          )
        )
        return
      }

      // Network-first for everything else (API calls)
      event.respondWith(fetch(event.request))
    })
    ```

    4. Create `public/offline.html` — simple offline fallback page:
    - KYN branding (dark bg, primary green text)
    - "Sem conexão" heading
    - "Você está offline. Verifique sua conexão e tente novamente." body text
    - Retry button that calls `window.location.reload()`
    - Inline styles (no external CSS since it's offline)
    - KYN logo as inline SVG or base64

    5. Update `src/app/layout.tsx` to register service worker:
    Add script to register sw.js:
    ```tsx
    // In layout.tsx, add to <head> or body:
    <script
      dangerouslySetInnerHTML={{
        __html: `
          if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
              navigator.serviceWorker.register('/sw.js')
            })
          }
        `,
      }}
    />
    ```
    Or better: create a `src/components/sw-register.tsx` client component that registers on mount.

    6. Verify manifest is accessible at /manifest.webmanifest (Next.js auto-generates from manifest.ts).
  </action>
  <verify>
    Visit localhost:3000/manifest.webmanifest — returns valid JSON manifest with icons.
    DevTools > Application > Manifest — shows installable PWA.
    DevTools > Application > Service Workers — sw.js registered.
    Turn off network in DevTools → navigate → offline.html fallback shown.
  </verify>
  <done>
    manifest.ts generates PWA manifest. Service worker caches static assets and serves offline fallback. App installable as PWA on mobile and desktop. Cache-Control headers prevent stale sw.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create authenticated app shell with responsive navigation</name>
  <files>
    src/app/(app)/layout.tsx
    src/app/(app)/page.tsx
    src/components/navigation/bottom-nav.tsx
    src/components/navigation/sidebar.tsx
    src/components/navigation/nav-items.ts
  </files>
  <action>
    1. Create `src/components/navigation/nav-items.ts` — shared navigation config:
    ```typescript
    import { Home, PiggyBank, Wallet, BarChart3, User } from 'lucide-react'

    export const navItems = [
      { label: 'Início', href: '/app', icon: Home },
      { label: 'Orçamento', href: '/app/orcamento', icon: PiggyBank },
      { label: 'Carteira', href: '/app/carteira', icon: Wallet },
      { label: 'Relatórios', href: '/app/relatorios', icon: BarChart3 },
      { label: 'Perfil', href: '/app/perfil', icon: User },
    ] as const
    ```

    2. Create `src/components/navigation/bottom-nav.tsx` — mobile bottom navigation ("use client"):
    - Fixed bottom bar (h-16, bg-white dark:bg-neutral-900, border-t)
    - 5 tabs from navItems, evenly spaced
    - Each tab: icon (24px) + label (text-xs) stacked vertically
    - Active tab: primary green color (#10b77f), inactive: muted gray
    - Use `usePathname()` from next/navigation to determine active tab
    - Safe area padding for iOS (pb-safe or env(safe-area-inset-bottom))
    - Only visible on mobile: `md:hidden`

    3. Create `src/components/navigation/sidebar.tsx` — desktop sidebar ("use client"):
    - Fixed left sidebar (w-64, h-screen, bg-white dark:bg-neutral-900, border-r)
    - KYN logo at top (from public/kyn-logo.png via next/image)
    - Nav items listed vertically with icon + label
    - Active item: bg-primary/10, text-primary, left border accent
    - Inactive: text-muted-foreground, hover:bg-muted
    - User info at bottom (placeholder — will be populated in Phase 4 settings)
    - Only visible on desktop: `hidden md:flex md:flex-col`

    4. Create `src/app/(app)/layout.tsx` — authenticated app layout:
    ```tsx
    import { createClient } from '@/lib/supabase/server'
    import { redirect } from 'next/navigation'
    import { BottomNav } from '@/components/navigation/bottom-nav'
    import { Sidebar } from '@/components/navigation/sidebar'

    export default async function AppLayout({ children }: { children: React.ReactNode }) {
      const supabase = await createClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        redirect('/login')
      }

      return (
        <div className="flex min-h-screen">
          {/* Desktop sidebar */}
          <Sidebar />

          {/* Main content */}
          <main className="flex-1 pb-16 md:pb-0 md:ml-64">
            <div className="container mx-auto px-4 py-6 max-w-4xl">
              {children}
            </div>
          </main>

          {/* Mobile bottom nav */}
          <BottomNav />
        </div>
      )
    }
    ```

    The layout does a server-side auth check (redundant with proxy.ts but ensures safety). Uses `redirect('/login')` if no user.

    Main content area has `pb-16` on mobile (space for bottom nav) and `md:ml-64` on desktop (space for sidebar).

    5. Create `src/app/(app)/page.tsx` — placeholder dashboard page:
    - Simple "Bem-vindo ao KYN" heading with user greeting
    - "Esta página será o dashboard. Em breve!" message
    - This will be replaced by the real dashboard in Phase 2

    6. Ensure forms open as sheets on mobile (PWAX-04): Install Shadcn Sheet component if not already added. The Sheet component is already added in Plan 01 (`npx shadcn add sheet`). The actual sheet usage will be in Phase 2 forms, but the component must be available. Confirm it's installed.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    Visit /app while authenticated:
    - Mobile (375px): bottom nav visible with 5 tabs, no sidebar.
    - Desktop (1280px): sidebar visible, no bottom nav.
    - Active tab highlighted in green.
    Visit /app unauthenticated: redirected to /login.
    Navigate between tabs: URL changes, active indicator updates.
  </verify>
  <done>
    App shell with responsive navigation. Mobile: fixed bottom nav with 5 tabs (Início, Orçamento, Carteira, Relatórios, Perfil). Desktop: fixed sidebar with logo and nav items. Active state uses primary green. Main content area properly spaced. Placeholder dashboard shows welcome message.
  </done>
</task>

</tasks>

<verification>
1. /manifest.webmanifest returns valid PWA manifest
2. Service worker registered in DevTools
3. Offline fallback works when network disabled
4. Chrome shows "Install" option in address bar
5. /app shows bottom nav on mobile, sidebar on desktop
6. Navigation tabs highlight correctly on active route
7. Content area has proper padding for nav elements
</verification>

<success_criteria>
- PWAX-01: App installable as PWA (manifest.ts + sw.js + icons)
- PWAX-02: Mobile bottom nav with 5 tabs (Início, Orçamento, Carteira, Relatórios, Perfil)
- PWAX-03: Desktop sidebar navigation
- PWAX-04: Sheet component available for forms (installed, usage in Phase 2)
- PWAX-05: Offline fallback page with "Sem conexão" message
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-04-SUMMARY.md`
</output>
