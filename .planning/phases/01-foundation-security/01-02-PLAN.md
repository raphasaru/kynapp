---
phase: 01-foundation-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/reset-password/page.tsx
  - src/app/(auth)/update-password/page.tsx
  - src/app/(auth)/layout.tsx
  - src/app/auth/callback/route.ts
  - src/app/auth/confirm/route.ts
  - src/app/proxy.ts
  - src/components/auth/login-form.tsx
  - src/components/auth/signup-form.tsx
  - src/components/auth/magic-link-form.tsx
  - src/components/auth/reset-password-form.tsx
  - src/components/auth/update-password-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can create account with email and password via /signup"
    - "User can sign in with email/password or magic link via /login"
    - "User can request password reset and update password"
    - "Auth callback handles magic link token verification"
    - "Unauthenticated user visiting /app/* is redirected to /login"
    - "Authenticated user visiting /login is redirected to /app"
    - "Session persists across browser refresh (proxy.ts refreshes token)"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with tabs (email/password + magic link)"
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup page with email + password + name"
    - path: "src/app/proxy.ts"
      provides: "Auth token refresh + route protection"
      exports: ["proxy", "config"]
    - path: "src/app/auth/callback/route.ts"
      provides: "Magic link and email verification callback"
      exports: ["GET"]
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "src/lib/supabase/client.ts"
      via: "supabase.auth.signInWithPassword / signInWithOtp"
      pattern: "signInWith"
    - from: "src/app/proxy.ts"
      to: "src/lib/supabase/server.ts"
      via: "createServerClient for cookie refresh"
      pattern: "createServerClient"
    - from: "src/app/auth/callback/route.ts"
      to: "supabase.auth.verifyOtp"
      via: "token_hash verification"
      pattern: "verifyOtp"
---

<objective>
Build complete authentication system: signup, login (email/password + magic link), password reset flow, auth callback, and proxy.ts for session refresh + route protection.

Purpose: Users need to create accounts and sign in to access the app. Auth is prerequisite for all protected features.
Output: Working auth flow with 5 pages, proxy-based route protection, and persistent sessions.
</objective>

<execution_context>
@/Users/charbellelopes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/charbellelopes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@design-system.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth pages with forms (signup, login, magic link, password reset)</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/signup/page.tsx
    src/app/(auth)/reset-password/page.tsx
    src/app/(auth)/update-password/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/signup-form.tsx
    src/components/auth/magic-link-form.tsx
    src/components/auth/reset-password-form.tsx
    src/components/auth/update-password-form.tsx
  </files>
  <action>
    1. Create `src/app/(auth)/layout.tsx` — auth layout with centered card, KYN logo, dark background (hsl(220 25% 7%)):
    - Centered vertically and horizontally
    - KYN logo at top
    - Card container for form content (max-w-md)
    - Link to go back to landing page (/)
    - No sidebar or bottom nav (auth pages are standalone)

    2. Create signup page `src/app/(auth)/signup/page.tsx` + `src/components/auth/signup-form.tsx`:
    - Fields: full_name (text), email, password (min 6 chars), confirm_password
    - Zod schema: `SignupSchema` with email().email(), password.min(6), confirmPassword refine match
    - React Hook Form with zodResolver
    - On submit: `supabase.auth.signUp({ email, password, options: { data: { full_name } } })`
    - On success: show "Verifique seu e-mail para confirmar a conta" message
    - On error: show error via form.setError("root", ...)
    - Link to /login: "Já tem conta? Entre aqui"
    - All labels in pt-BR: "Nome completo", "Email", "Senha", "Confirmar senha", "Criar conta"
    - Use Shadcn Button, Input, Form, FormField, FormItem, FormLabel, FormMessage, Card

    3. Create login page `src/app/(auth)/login/page.tsx` with TWO tabs (Shadcn Tabs):
    - Tab 1 "Email e Senha": `src/components/auth/login-form.tsx`
      - Fields: email, password
      - On submit: `supabase.auth.signInWithPassword({ email, password })`
      - On success: `router.push('/app')` (or /app/dashboard)
      - Link to /reset-password: "Esqueceu a senha?"
    - Tab 2 "Magic Link": `src/components/auth/magic-link-form.tsx`
      - Field: email only
      - On submit: `supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: '${origin}/auth/callback' } })`
      - On success: show "Link enviado! Verifique seu e-mail."
    - Link to /signup: "Não tem conta? Crie aqui"
    - All text in pt-BR

    4. Create reset password page `src/app/(auth)/reset-password/page.tsx` + form:
    - Field: email
    - On submit: `supabase.auth.resetPasswordForEmail(email, { redirectTo: '${origin}/update-password' })`
    - On success: "Link de recuperação enviado para seu e-mail"
    - Link back to /login

    5. Create update password page `src/app/(auth)/update-password/page.tsx` + form:
    - Fields: new_password, confirm_password
    - Zod: min 6 chars, passwords match
    - On submit: `supabase.auth.updateUser({ password: newPassword })`
    - On success: redirect to /app
    - This page is only accessible via the reset password email link (Supabase sets session from URL)

    All forms use "use client" directive. All use Shadcn form components. All show loading state on button during submission. All handle errors gracefully with pt-BR messages.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    Visit /signup — form renders with all fields, validation fires on empty submit.
    Visit /login — tabs switch between email/password and magic link forms.
    Visit /reset-password — email field renders.
  </verify>
  <done>
    All 4 auth pages render with proper Shadcn forms, Zod validation, and Supabase auth calls. All text in pt-BR. Forms handle loading states and errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create proxy.ts for auth session refresh and route protection + auth callback</name>
  <files>
    src/app/proxy.ts
    src/app/auth/callback/route.ts
    src/app/auth/confirm/route.ts
  </files>
  <action>
    1. Create `src/app/proxy.ts` (replaces middleware.ts in Next.js 15.5+):
    ```typescript
    import { createServerClient } from '@supabase/ssr'
    import { NextResponse, type NextRequest } from 'next/server'

    export async function proxy(request: NextRequest) {
      let supabaseResponse = NextResponse.next({ request })

      const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
          cookies: {
            getAll() { return request.cookies.getAll() },
            setAll(cookiesToSet) {
              cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
              supabaseResponse = NextResponse.next({ request })
              cookiesToSet.forEach(({ name, value, options }) =>
                supabaseResponse.cookies.set(name, value, options)
              )
            },
          },
        }
      )

      // Refresh session token (IMPORTANT: use getUser not getSession)
      const { data: { user } } = await supabase.auth.getUser()

      const pathname = request.nextUrl.pathname
      const isAuthRoute = pathname.startsWith('/login') ||
                          pathname.startsWith('/signup') ||
                          pathname.startsWith('/reset-password') ||
                          pathname.startsWith('/update-password')
      const isProtectedRoute = pathname.startsWith('/app')

      // Redirect unauthenticated users away from protected routes
      if (!user && isProtectedRoute) {
        const url = request.nextUrl.clone()
        url.pathname = '/login'
        return NextResponse.redirect(url)
      }

      // Redirect authenticated users away from auth routes
      if (user && isAuthRoute) {
        const url = request.nextUrl.clone()
        url.pathname = '/app'
        return NextResponse.redirect(url)
      }

      return supabaseResponse
    }

    export const config = {
      matcher: [
        '/((?!_next/static|_next/image|favicon.ico|icons/|.*\\.(?:svg|png|jpg|jpeg|gif|webp|js|css)$).*)',
      ],
    }
    ```

    IMPORTANT: Use `getUser()` not `getSession()` — getSession doesn't validate JWT expiry. Double-check Next.js 15.5+ proxy.ts file convention works. If the version being used is < 15.5 and proxy.ts isn't supported yet, use `middleware.ts` with identical logic instead (check Next.js version in package.json after install).

    2. Create `src/app/auth/callback/route.ts` — handles magic link and email verification:
    ```typescript
    import { createClient } from '@/lib/supabase/server'
    import { NextResponse } from 'next/server'

    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url)
      const code = searchParams.get('code')
      const token_hash = searchParams.get('token_hash')
      const type = searchParams.get('type') as string
      const next = searchParams.get('next') ?? '/app'

      if (code) {
        const supabase = await createClient()
        const { error } = await supabase.auth.exchangeCodeForSession(code)
        if (!error) {
          return NextResponse.redirect(`${origin}${next}`)
        }
      }

      if (token_hash && type) {
        const supabase = await createClient()
        const { error } = await supabase.auth.verifyOtp({ token_hash, type: type as any })
        if (!error) {
          return NextResponse.redirect(`${origin}${next}`)
        }
      }

      // Error: redirect to login with error param
      return NextResponse.redirect(`${origin}/login?error=auth_callback_failed`)
    }
    ```

    3. Create `src/app/auth/confirm/route.ts` — handles email confirmation links:
    Same pattern as callback but specifically for email confirmation (type=signup, type=email).

    4. Handle auth state change on client side — ensure the (auth) layout or a shared provider listens for `onAuthStateChange` so navigation works after magic link opens in same browser. Use `supabase.auth.onAuthStateChange` in a client component or hook if needed.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    Visit /app without auth → redirected to /login.
    Sign up → confirmation email sent (check Supabase logs).
    Sign in with password → redirected to /app.
    Refresh page while authenticated → session persists (not redirected to login).
  </verify>
  <done>
    proxy.ts handles auth token refresh on every request. Unauthenticated users redirected from /app/* to /login. Authenticated users redirected from auth pages to /app. Auth callback handles code exchange and OTP verification. Session persists across refresh.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` and `npx tsc --noEmit` pass
2. Navigate to /signup → create account → "check email" message shown
3. Navigate to /login → sign in with password → redirected to /app
4. Navigate to /login magic link tab → send magic link → "link sent" message
5. Visit /app unauthenticated → redirected to /login
6. Visit /login authenticated → redirected to /app
7. Refresh authenticated page → session persists
8. Navigate to /reset-password → request reset → email sent
</verification>

<success_criteria>
- AUTH-01: Signup with email/password works
- AUTH-02: Magic link login sends email and callback verifies token
- AUTH-03: Password reset flow sends email and update-password page works
- AUTH-04: Session persists across refresh (proxy.ts refreshes token)
- AUTH-05: Unauthenticated users redirected to /login from protected routes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-02-SUMMARY.md`
</output>
